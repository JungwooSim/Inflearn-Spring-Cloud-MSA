"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[2364],{"./public/app/plugins/datasource/grafana-azure-monitor-datasource/module.ts":(e,t,s)=>{s.r(t),s.d(t,{plugin:()=>Re});var r=s("./packages/grafana-data/src/index.ts"),a=s("../../opt/drone/yarncache/lodash-npm-4.17.21-6382451519-eb835a2e51.zip/node_modules/lodash/lodash.js"),i=s.n(a);class o{static buildAzureMonitorGetMetricNamespacesUrl(e,t,s,r,a,i){const o=r.split("/"),n=a.split("/"),c=[e,t,"resourceGroups",s,"providers",o.shift()];for(const e in o)c.push(o[e]),c.push(n[e]);return`${c.join("/")}/providers/microsoft.insights/metricNamespaces?api-version=${i}`}static buildAzureMonitorGetMetricNamesUrl(e,t,s,r,a,i,o){const n=r.split("/"),c=a.split("/"),u=[e,t,"resourceGroups",s,"providers",n.shift()];for(const e in n)u.push(n[e]),u.push(c[e]);return`${u.join("/")}/providers/microsoft.insights/metricdefinitions?api-version=${o}&metricnamespace=${encodeURIComponent(i)}`}}var n=s("./public/app/plugins/datasource/grafana-azure-monitor-datasource/time_grain_converter.ts");class c{static parseResponseValues(e,t,s){const r=[];if(!e)return r;for(let i=0;i<e.value.length;i++)if(!(0,a.find)(r,["value",(0,a.get)(e.value[i],s)])){const o=(0,a.get)(e.value[i],s),n=(0,a.get)(e.value[i],t,o);r.push({text:n,value:o})}return r}static parseResourceNames(e,t){const s=[];if(!e)return s;for(let r=0;r<e.value.length;r++)"string"==typeof e.value[r].type&&e.value[r].type.toLocaleLowerCase()===t.toLocaleLowerCase()&&s.push({text:e.value[r].name,value:e.value[r].name});return s}static parseMetadata(e,t){var s,r;const a=["None","Average","Minimum","Maximum","Total","Count"],i=null==e?void 0:e.value.find((e=>e.name.value===t));return i?{primaryAggType:i.primaryAggregationType,supportedAggTypes:i.supportedAggregationTypes||a,supportedTimeGrains:[{label:"Auto",value:"auto"},...c.parseTimeGrains(null!==(s=i.metricAvailabilities)&&void 0!==s?s:[])],dimensions:c.parseDimensions(null!==(r=i.dimensions)&&void 0!==r?r:[])}:{primaryAggType:"",supportedAggTypes:a,supportedTimeGrains:[],dimensions:[]}}static parseTimeGrains(e){const t=[];return e?(e.forEach((e=>{e.timeGrain&&t.push({label:n.Z.createTimeGrainFromISO8601Duration(e.timeGrain),value:e.timeGrain})})),t):t}static parseDimensions(e){return e.map((e=>({label:e.localizedValue||e.value,value:e.value})))}static parseSubscriptions(e){const t=[];if(!e)return t;const s="subscriptionId";for(let r=0;r<e.value.length;r++)(0,a.find)(t,["value",(0,a.get)(e.value[r],s)])||t.push({text:`${(0,a.get)(e.value[r],"displayName")}`,value:(0,a.get)(e.value[r],s)});return t}static parseSubscriptionsForSelect(e){const t=[];if(!e)return t;const s="subscriptionId";for(let r=0;r<e.data.value.length;r++)(0,a.find)(t,["value",(0,a.get)(e.data.value[r],s)])||t.push({label:`${(0,a.get)(e.data.value[r],"displayName")} - ${(0,a.get)(e.data.value[r],s)}`,value:(0,a.get)(e.data.value[r],s)});return t}static parseWorkspacesForSelect(e){const t=[];if(!e)return t;const s="customerId";for(let r=0;r<e.data.value.length;r++)(0,a.find)(t,["value",(0,a.get)(e.data.value[r].properties,s)])||t.push({label:(0,a.get)(e.data.value[r],"name"),value:(0,a.get)(e.data.value[r].properties,s)});return t}}class u{constructor(e){var t,s,r;r={azuremonitor:["Microsoft.AnalysisServices/servers","Microsoft.ApiManagement/service","Microsoft.AppConfiguration/configurationStores","Microsoft.Automation/automationAccounts","Microsoft.Batch/batchAccounts","Microsoft.Cache/redis","Microsoft.Cdn/cdnwebapplicationfirewallpolicies","Microsoft.Cdn/profiles","Microsoft.ClassicCompute/virtualMachines","Microsoft.ClassicCompute/domainNames/slots/roles","Microsoft.CognitiveServices/accounts","Microsoft.Compute/virtualMachines","Microsoft.Compute/virtualMachineScaleSets","Microsoft.ContainerInstance/containerGroups","Microsoft.ContainerRegistry/registries","Microsoft.ContainerService/managedClusters","Microsoft.CustomerInsights/hubs","Microsoft.DataBoxEdge/dataBoxEdgeDevices","Microsoft.DataFactory/datafactories","Microsoft.DataFactory/factories","Microsoft.DataLakeAnalytics/accounts","Microsoft.DataLakeStore/accounts","Microsoft.DBforMariaDB/servers","Microsoft.DBforMySQL/servers","Microsoft.DBforMySQL/flexibleServers","Microsoft.DBforPostgreSQL/servers","Microsoft.DBforPostgreSQL/flexibleServers","Microsoft.Devices/IotHubs","Microsoft.Devices/provisioningServices","Microsoft.DocumentDB/databaseAccounts","Microsoft.EventGrid/topics","Microsoft.EventGrid/eventSubscriptions","Microsoft.EventGrid/extensionTopics","Microsoft.EventHub/namespaces","Microsoft.EventHub/clusters","Microsoft.HDInsight/clusters","Microsoft.Insights/AutoscaleSettings","Microsoft.Insights/components","Microsoft.KeyVault/vaults","Microsoft.Kusto/clusters","Microsoft.LocationBasedServices/accounts","Microsoft.Logic/workflows","Microsoft.Logic/integrationServiceEnvironments","Microsoft.NetApp/netAppAccounts/capacityPools","Microsoft.NetApp/netAppAccounts/capacityPools/volumes","Microsoft.Network/networkInterfaces","Microsoft.Network/loadBalancers","Microsoft.Network/dnsZones","Microsoft.Network/publicIPAddresses","Microsoft.Network/azureFirewalls","Microsoft.Network/applicationGateways","Microsoft.Network/virtualNetworkGateways","Microsoft.Network/expressRouteCircuits","Microsoft.Network/expressRouteCircuits/Peerings","Microsoft.Network/connections","Microsoft.Network/trafficManagerProfiles","Microsoft.Network/networkWatchers/connectionMonitors","Microsoft.Network/frontdoors","Microsoft.Network/natGateways","Microsoft.Network/vpngateways","Microsoft.Network/virtualNetworkGateways","Microsoft.NotificationHubs/namespaces/notificationHubs","Microsoft.OperationalInsights/workspaces","Microsoft.PowerBIDedicated/capacities","Microsoft.Relay/namespaces","Microsoft.Search/searchServices","Microsoft.ServiceBus/namespaces","Microsoft.SignalRService/SignalR","Microsoft.Sql/servers/databases","Microsoft.Sql/servers/elasticPools","Microsoft.Sql/managedInstances","Microsoft.Storage/storageAccounts","Microsoft.Storage/storageAccounts/blobServices","Microsoft.Storage/storageAccounts/fileServices","Microsoft.Storage/storageAccounts/queueServices","Microsoft.Storage/storageAccounts/tableServices","Microsoft.StorageSync/storageSyncServices","Microsoft.StorageSync/storageSyncServices/syncGroups","Microsoft.StorageSync/storageSyncServices/syncGroups/serverEndpoints","Microsoft.StorageSync/storageSyncServices/registeredServers","Microsoft.StreamAnalytics/streamingJobs","Microsoft.Web/serverfarms","Microsoft.Web/sites","Microsoft.Web/sites/slots","Microsoft.Web/hostingEnvironments/multiRolePools","Microsoft.Web/hostingEnvironments/workerPools"],govazuremonitor:["Microsoft.AnalysisServices/servers","Microsoft.ApiManagement/service","Microsoft.Batch/batchAccounts","Microsoft.Cache/redis","Microsoft.Cdn/cdnwebapplicationfirewallpolicies","Microsoft.Cdn/profiles","Microsoft.ClassicCompute/virtualMachines","Microsoft.ClassicCompute/domainNames/slots/roles","Microsoft.CognitiveServices/accounts","Microsoft.Compute/virtualMachines","Microsoft.Compute/virtualMachineScaleSets","Microsoft.ContainerRegistry/registries","Microsoft.DBforMySQL/servers","Microsoft.DBforPostgreSQL/servers","Microsoft.Devices/IotHubs","Microsoft.Devices/provisioningServices","Microsoft.EventGrid/topics","Microsoft.EventGrid/eventSubscriptions","Microsoft.EventGrid/extensionTopics","Microsoft.EventHub/namespaces","Microsoft.EventHub/clusters","Microsoft.Insights/AutoscaleSettings","Microsoft.Insights/components","Microsoft.KeyVault/vaults","Microsoft.Logic/workflows","Microsoft.Network/networkInterfaces","Microsoft.Network/loadBalancers","Microsoft.Network/dnsZones","Microsoft.Network/publicIPAddresses","Microsoft.Network/azureFirewalls","Microsoft.Network/applicationGateways","Microsoft.Network/virtualNetworkGateways","Microsoft.Network/expressRouteCircuits","Microsoft.Network/expressRouteCircuits/Peerings","Microsoft.Network/connections","Microsoft.Network/trafficManagerProfiles","Microsoft.Network/networkWatchers/connectionMonitors","Microsoft.Network/frontdoors","Microsoft.NotificationHubs/namespaces/notificationHubs","Microsoft.OperationalInsights/workspaces","Microsoft.PowerBIDedicated/capacities","Microsoft.Relay/namespaces","Microsoft.ServiceBus/namespaces","Microsoft.Sql/servers/databases","Microsoft.Sql/servers/elasticPools","Microsoft.Sql/managedInstances","Microsoft.Storage/storageAccounts","Microsoft.Storage/storageAccounts/blobServices","Microsoft.Storage/storageAccounts/fileServices","Microsoft.Storage/storageAccounts/queueServices","Microsoft.Storage/storageAccounts/tableServices","Microsoft.Web/serverfarms","Microsoft.Web/sites","Microsoft.Web/sites/slots","Microsoft.Web/hostingEnvironments/multiRolePools","Microsoft.Web/hostingEnvironments/workerPools"],germanyazuremonitor:["Microsoft.AnalysisServices/servers","Microsoft.Batch/batchAccounts","Microsoft.Cache/redis","Microsoft.Cdn/cdnwebapplicationfirewallpolicies","Microsoft.Cdn/profiles","Microsoft.ClassicCompute/virtualMachines","Microsoft.ClassicCompute/domainNames/slots/roles","Microsoft.Compute/virtualMachines","Microsoft.Compute/virtualMachineScaleSets","Microsoft.DBforMySQL/servers","Microsoft.DBforPostgreSQL/servers","Microsoft.Devices/IotHubs","Microsoft.Devices/provisioningServices","Microsoft.EventHub/namespaces","Microsoft.EventHub/clusters","Microsoft.Insights/AutoscaleSettings","Microsoft.Insights/components","Microsoft.KeyVault/vaults","Microsoft.Network/networkInterfaces","Microsoft.Network/loadBalancers","Microsoft.Network/dnsZones","Microsoft.Network/publicIPAddresses","Microsoft.Network/azureFirewalls","Microsoft.Network/applicationGateways","Microsoft.Network/virtualNetworkGateways","Microsoft.Network/expressRouteCircuits","Microsoft.Network/expressRouteCircuits/Peerings","Microsoft.Network/connections","Microsoft.Network/trafficManagerProfiles","Microsoft.Network/networkWatchers/connectionMonitors","Microsoft.Network/frontdoors","Microsoft.NotificationHubs/namespaces/notificationHubs","Microsoft.OperationalInsights/workspaces","Microsoft.PowerBIDedicated/capacities","Microsoft.Relay/namespaces","Microsoft.ServiceBus/namespaces","Microsoft.Sql/servers/databases","Microsoft.Sql/servers/elasticPools","Microsoft.Sql/managedInstances","Microsoft.Storage/storageAccounts","Microsoft.Storage/storageAccounts/blobServices","Microsoft.Storage/storageAccounts/fileServices","Microsoft.Storage/storageAccounts/queueServices","Microsoft.Storage/storageAccounts/tableServices","Microsoft.StreamAnalytics/streamingJobs","Microsoft.Web/serverfarms","Microsoft.Web/sites","Microsoft.Web/sites/slots","Microsoft.Web/hostingEnvironments/multiRolePools","Microsoft.Web/hostingEnvironments/workerPools"],chinaazuremonitor:["Microsoft.AnalysisServices/servers","Microsoft.Batch/batchAccounts","Microsoft.Cache/redis","Microsoft.Cdn/cdnwebapplicationfirewallpolicies","Microsoft.Cdn/profiles","Microsoft.ClassicCompute/virtualMachines","Microsoft.ClassicCompute/domainNames/slots/roles","Microsoft.CognitiveServices/accounts","Microsoft.Compute/virtualMachines","Microsoft.Compute/virtualMachineScaleSets","Microsoft.ContainerRegistry/registries","Microsoft.DBforMySQL/servers","Microsoft.DBforPostgreSQL/servers","Microsoft.Devices/IotHubs","Microsoft.Devices/provisioningServices","Microsoft.EventHub/namespaces","Microsoft.Insights/AutoscaleSettings","Microsoft.Insights/components","Microsoft.KeyVault/vaults","Microsoft.Logic/workflows","Microsoft.Network/networkInterfaces","Microsoft.Network/loadBalancers","Microsoft.Network/dnsZones","Microsoft.Network/publicIPAddresses","Microsoft.Network/azureFirewalls","Microsoft.Network/applicationGateways","Microsoft.Network/virtualNetworkGateways","Microsoft.Network/expressRouteCircuits","Microsoft.Network/expressRouteCircuits/Peerings","Microsoft.Network/connections","Microsoft.Network/trafficManagerProfiles","Microsoft.Network/networkWatchers/connectionMonitors","Microsoft.Network/frontdoors","Microsoft.NotificationHubs/namespaces/notificationHubs","Microsoft.PowerBIDedicated/capacities","Microsoft.Relay/namespaces","Microsoft.ServiceBus/namespaces","Microsoft.Sql/servers/databases","Microsoft.Sql/servers/elasticPools","Microsoft.Sql/managedInstances","Microsoft.Storage/storageAccounts","Microsoft.Storage/storageAccounts/blobServices","Microsoft.Storage/storageAccounts/fileServices","Microsoft.Storage/storageAccounts/queueServices","Microsoft.Storage/storageAccounts/tableServices","Microsoft.StreamAnalytics/streamingJobs","Microsoft.Web/serverfarms","Microsoft.Web/sites","Microsoft.Web/sites/slots","Microsoft.Web/hostingEnvironments/multiRolePools","Microsoft.Web/hostingEnvironments/workerPools"]},(s="supportedMetricNamespaces")in(t=this)?Object.defineProperty(t,s,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[s]=r,this.cloudName=e,this.cloudName=e}get(){return this.supportedMetricNamespaces[this.cloudName]}}var l=s("./public/app/plugins/datasource/grafana-azure-monitor-datasource/types/index.ts"),p=s("./packages/grafana-runtime/src/index.ts"),d=s("./public/app/features/dashboard/services/TimeSrv.ts");const h=Symbol("Concealed client secret");function m(e){return e.jsonData.azureAuthType?e.jsonData.azureAuthType:e.jsonData.tenantId&&e.jsonData.clientId?"clientsecret":p.config.azure.managedIdentityEnabled?"msi":"clientsecret"}function g(){switch(p.config.azure.cloud){case l._.Public:case l._.None:case void 0:return"azuremonitor";case l._.China:return"chinaazuremonitor";case l._.USGovernment:return"govazuremonitor";case l._.Germany:return"germanyazuremonitor";default:throw new Error(`The cloud '${p.config.azure.cloud}' not supported.`)}}function f(e){switch(e){case"azuremonitor":return"https://portal.azure.com";case"chinaazuremonitor":return"https://portal.azure.cn";case"govazuremonitor":return"https://portal.azure.us";case"germanyazuremonitor":return"https://portal.microsoftazure.de";default:throw new Error("The cloud not supported.")}}function y(e){switch(m(e)){case"msi":return g();case"clientsecret":return e.jsonData.cloudName||g()}}function v(e){if(e.secureJsonFields.clientSecret)return h;{var t;const s=null===(t=e.secureJsonData)||void 0===t?void 0:t.clientSecret;return"string"==typeof s&&s.length>0?s:void 0}}function b(e){switch(m(e)){case"msi":return p.config.azure.managedIdentityEnabled?{authType:"msi",defaultSubscriptionId:e.jsonData.subscriptionId}:{authType:"clientsecret",azureCloud:g()};case"clientsecret":return{authType:"clientsecret",azureCloud:e.jsonData.cloudName||g(),tenantId:e.jsonData.tenantId,clientId:e.jsonData.clientId,clientSecret:v(e),defaultSubscriptionId:e.jsonData.subscriptionId}}}var M=s("./public/app/plugins/datasource/grafana-azure-monitor-datasource/azureMetadata/index.ts"),S=s("./public/app/plugins/datasource/grafana-azure-monitor-datasource/utils/common.ts");function w(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}const N="select";class I extends p.DataSourceWithBackend{constructor(e){super(e),w(this,"apiVersion","2018-01-01"),w(this,"apiPreviewVersion","2017-12-01-preview"),w(this,"defaultSubscriptionId",void 0),w(this,"resourcePath",void 0),w(this,"azurePortalUrl",void 0),w(this,"supportedMetricNamespaces",[]),w(this,"timeSrv",void 0),this.instanceSettings=e,this.instanceSettings=e,this.timeSrv=(0,d.$t)(),this.defaultSubscriptionId=e.jsonData.subscriptionId;const t=y(e);this.resourcePath=`${S.kr.azureMonitor}/subscriptions`,this.supportedMetricNamespaces=new u(t).get(),this.azurePortalUrl=f(t)}isConfigured(){return!this.validateDatasource()}filterQuery(e){return!!(!0!==e.hide&&e.azureMonitor&&e.azureMonitor.resourceGroup&&e.azureMonitor.resourceGroup!==N&&e.azureMonitor.resourceName&&e.azureMonitor.resourceName!==N&&e.azureMonitor.metricDefinition&&e.azureMonitor.metricDefinition!==N&&e.azureMonitor.metricName&&e.azureMonitor.metricName!==N&&e.azureMonitor.aggregation&&e.azureMonitor.aggregation!==N)}applyTemplateVariables(e,t){var s;const r=e.azureMonitor;if(!r)throw new Error("Query is not a valid Azure Monitor Metrics query");r.timeGrain&&r.timeGrainUnit&&"auto"!==r.timeGrain&&(r.timeGrain=n.Z.createISO8601Duration(r.timeGrain,r.timeGrainUnit));const a=(0,p.getTemplateSrv)(),i=a.replace(e.subscription||this.defaultSubscriptionId,t),o=a.replace(r.resourceGroup,t),c=a.replace(r.resourceName,t),u=a.replace(r.metricNamespace,t),d=a.replace(r.metricDefinition,t),h=a.replace((r.timeGrain||"").toString(),t),m=a.replace(r.aggregation,t),g=a.replace(r.top||"",t),f=(null!==(s=r.dimensionFilters)&&void 0!==s?s:[]).filter((e=>e.dimension&&"None"!==e.dimension)).map((e=>{var s;const r=a.replace(null!==(s=e.filter)&&void 0!==s?s:"",t);return{dimension:a.replace(e.dimension,t),operator:e.operator||"eq",filter:r||"*"}}));return{refId:e.refId,subscription:i,queryType:l.B.AzureMonitor,azureMonitor:{resourceGroup:o,resourceName:c,metricDefinition:d,timeGrain:h,allowedTimeGrainsMs:r.allowedTimeGrainsMs,metricName:a.replace(r.metricName,t),metricNamespace:u&&u!==N?u:d,aggregation:m,dimensionFilters:f,top:g||"10",alias:r.alias}}}async getSubscriptions(){return this.isConfigured()?this.getResource(`${this.resourcePath}?api-version=2019-03-01`).then((e=>c.parseSubscriptions(e))):[]}getResourceGroups(e){return this.getResource(`${this.resourcePath}/${e}/resourceGroups?api-version=${this.apiVersion}`).then((e=>c.parseResponseValues(e,"name","name")))}getMetricDefinitions(e,t){return this.getResource(`${this.resourcePath}/${e}/resourceGroups/${t}/resources?api-version=${this.apiVersion}`).then((e=>c.parseResponseValues(e,"type","type"))).then((e=>(0,a.filter)(e,(e=>{for(let t=0;t<this.supportedMetricNamespaces.length;t++)if(e.value.toLowerCase()===this.supportedMetricNamespaces[t].toLowerCase())return!0;return!1})))).then((e=>{let t=!1;for(let s=0;s<e.length;s++)if("Microsoft.Storage/storageAccounts"===e[s].value){t=!0;break}return t&&(e.push({text:"Microsoft.Storage/storageAccounts/blobServices",value:"Microsoft.Storage/storageAccounts/blobServices"}),e.push({text:"Microsoft.Storage/storageAccounts/fileServices",value:"Microsoft.Storage/storageAccounts/fileServices"}),e.push({text:"Microsoft.Storage/storageAccounts/tableServices",value:"Microsoft.Storage/storageAccounts/tableServices"}),e.push({text:"Microsoft.Storage/storageAccounts/queueServices",value:"Microsoft.Storage/storageAccounts/queueServices"})),e.map((e=>({value:e.value,text:M.D8[e.value.toLowerCase()]||e.value})))}))}getResourceNames(e,t,s){return this.getResource(`${this.resourcePath}/${e}/resourceGroups/${t}/resources?api-version=${this.apiVersion}`).then((e=>{if(!(0,a.startsWith)(s,"Microsoft.Storage/storageAccounts/"))return c.parseResourceNames(e,s);const t=c.parseResourceNames(e,"Microsoft.Storage/storageAccounts");for(let e=0;e<t.length;e++)t[e].text+="/default",t[e].value+="/default";return t}))}getMetricNamespaces(e,t,s,r){const a=o.buildAzureMonitorGetMetricNamespacesUrl(this.resourcePath,e,t,s,r,this.apiPreviewVersion);return this.getResource(a).then((e=>c.parseResponseValues(e,"name","properties.metricNamespaceName")))}getMetricNames(e,t,s,r,a){const i=o.buildAzureMonitorGetMetricNamesUrl(this.resourcePath,e,t,s,r,a,this.apiVersion);return this.getResource(i).then((e=>c.parseResponseValues(e,"name.localizedValue","name.value")))}getMetricMetadata(e,t,s,r,a,i){const n=o.buildAzureMonitorGetMetricNamesUrl(this.resourcePath,e,t,s,r,a,this.apiVersion);return this.getResource(n).then((e=>c.parseMetadata(e,i)))}async testDatasource(){const e=this.validateDatasource();if(e)return Promise.resolve(e);try{const e=`${this.resourcePath}?api-version=2019-03-01`;return await this.getResource(e).then((e=>({status:"success",message:"Successfully queried the Azure Monitor service.",title:"Success"})))}catch(e){let t="Azure Monitor: ";return t+=e.statusText?e.statusText+": ":"",e.data&&e.data.error&&e.data.error.code?t+=e.data.error.code+". "+e.data.error.message:e.data&&e.data.error?t+=e.data.error:e.data?t+=e.data:t+="Cannot connect to Azure Monitor REST API.",{status:"error",message:t}}}validateDatasource(){if("clientsecret"===m(this.instanceSettings)){if(!this.isValidConfigField(this.instanceSettings.jsonData.tenantId))return{status:"error",message:"The Tenant Id field is required."};if(!this.isValidConfigField(this.instanceSettings.jsonData.clientId))return{status:"error",message:"The Client Id field is required."}}}isValidConfigField(e){return"string"==typeof e&&e.length>0}}class A{constructor(e){this.results=e,this.results=e}parseQueryResult(){let e=[],t=[];for(let s=0;s<this.results.length;s++)if(this.results[s].query.raw){const r=this.results[s].query.xaxis,i=this.results[s].query.yaxis,o=this.results[s].query.spliton;t=this.results[s].result.Tables[0].Columns;const n=this.results[s].result.Tables[0].Rows;e=(0,a.concat)(e,this.parseRawQueryResultRow(this.results[s].query,t,n,r,i,o))}else{const t=this.results[s].result.value,r=this.results[s].query.alias;e=(0,a.concat)(e,this.parseQueryResultRow(this.results[s].query,t,r))}return e}parseRawQueryResultRow(e,t,s,r,i,o){const n=[],c=(0,a.map)(t,(e=>({text:e.ColumnName,value:e.ColumnName}))),u=t.findIndex((e=>e.ColumnName===r)),l=i.split(","),p={};(0,a.forEach)(l,(e=>{p[e]=t.findIndex((t=>t.ColumnName===e))}));const d=t.findIndex((e=>e.ColumnName===o)),h="timestamp"===r;return(0,a.forEach)(s,(t=>{(0,a.forEach)(p,((s,r)=>{const a=-1===d?A.findOrCreateBucket(n,r):A.findOrCreateBucket(n,t[d]),i=h?A.dateTimeToEpoch(t[u]):t[u];a.datapoints.push([t[s],i]),a.refId=e.refId,a.query=e.query,a.columnsForDropdown=c}))})),n}parseQueryResultRow(e,t,s){const r=[];if(A.isSingleValue(t)){const s=A.getMetricFieldKey(t),a=A.getKeyForAggregationField(t[s]),i=A.dateTimeToEpoch(t.end);return r.push({target:s,datapoints:[[t[s][a],i]],refId:e.refId,query:e.query}),r}if(A.hasSegmentsField(t.segments[0]))for(let a=0;a<t.segments.length;a++){const i=A.dateTimeToEpoch(t.segments[a].end);for(let o=0;o<t.segments[a].segments.length;o++){const n=A.getMetricFieldKey(t.segments[a].segments[o]),c=A.getKeyForAggregationField(t.segments[a].segments[o][n]),u=this.getTargetName(t.segments[a].segments[o],s),l=A.findOrCreateBucket(r,u);l.datapoints.push([t.segments[a].segments[o][n][c],i]),l.refId=e.refId,l.meta={query:e.query}}}else{const s=A.getMetricFieldKey(t.segments[0]),a=A.findOrCreateBucket(r,s);for(let e=0;e<t.segments.length;e++){const r=A.dateTimeToEpoch(t.segments[e].end),i=A.getKeyForAggregationField(t.segments[e][s]);a.datapoints.push([t.segments[e][s][i],r])}a.refId=e.refId,a.query=e.query}return r}getTargetName(e,t){let s="",r="",i="";for(const t in e)(0,a.isObject)(e[t])?s=t:(r=t,i=e[t]);if(t){const e=/\{\{([\s\S]+?)\}\}/g;return t.replace(e,((e,t,a)=>{const o=t||a;return"metric"===o?s:"groupbyname"===o?r:"groupbyvalue"===o?i:e}))}return s+`{${r}="${i}"}`}static isSingleValue(e){return!A.hasSegmentsField(e)}static findOrCreateBucket(e,t){let s=(0,a.find)(e,["target",t]);return s||(s={target:t,datapoints:[]},e.push(s)),s}static hasSegmentsField(e){const t=(0,a.keys)(e);return(0,a.indexOf)(t,"segments")>-1}static getMetricFieldKey(e){const t=(0,a.keys)(e);return(0,a.filter)((0,a.without)(t,"start","end"),(t=>(0,a.isObject)(e[t])))[0]}static getKeyForAggregationField(e){const t=(0,a.keys)(e);return(0,a.intersection)(t,["sum","avg","min","max","count","unique"])[0]}static dateTimeToEpoch(e){return(0,r.dateTime)(e).valueOf()}static parseMetricNames(e){const t=(0,a.keys)(e.metrics);return A.toTextValueList(t)}parseMetadata(e){const t=this.results.metrics[e];if(!t)throw Error("No data found for metric: "+e);return{primaryAggType:t.defaultAggregation,supportedAggTypes:t.supportedAggregations,supportedGroupBy:t.supportedGroupBy.all}}parseGroupBys(){return A.toTextValueList(this.results.supportedGroupBy)}parseQuerySchema(){const e={Type:"AppInsights",Tables:{}};if(this.results&&this.results&&this.results.Tables)for(let t=0;t<this.results.Tables[0].Rows.length;t++){const s=this.results.Tables[0].Rows[t],r=s[0],a=s[1],i=s[2];e.Tables[r]?e.Tables[r].OrderedColumns.push({Name:a,Type:i}):e.Tables[r]={Name:r,OrderedColumns:[{Name:a,Type:i}]}}return e}static toTextValueList(e){const t=[];for(let s=0;s<e.length;s++)t.push({text:e[s],value:e[s]});return t}}function D(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class k extends p.DataSourceWithBackend{constructor(e){super(e),D(this,"resourcePath",void 0),D(this,"version","beta"),D(this,"applicationId",void 0),D(this,"logAnalyticsColumns",{}),this.applicationId=e.jsonData.appInsightsAppId||"",this.resourcePath=`${S.kr.appInsights}/${this.version}/apps/${this.applicationId}`}isConfigured(){return!!this.applicationId&&this.applicationId.length>0}createRawQueryRequest(e,t,s){return e.xaxis&&!e.timeColumn&&(e.timeColumn=e.xaxis),e.yaxis&&!e.valueColumn&&(e.valueColumn=e.yaxis),e.spliton&&!e.segmentColumn&&(e.segmentColumn=e.spliton),{type:"timeSeriesQuery",raw:!1,appInsights:{rawQuery:!0,rawQueryString:(0,p.getTemplateSrv)().replace(e.rawQueryString,t.scopedVars),timeColumn:e.timeColumn,valueColumn:e.valueColumn,segmentColumn:e.segmentColumn}}}applyTemplateVariables(e,t){const s=e.appInsights;if(!s)return e;const r=s;r.timeGrainCount?s.timeGrain=n.Z.createISO8601Duration(r.timeGrainCount,s.timeGrainUnit):s.timeGrain&&s.timeGrainUnit&&"auto"!==s.timeGrain&&(s.timeGrain=n.Z.createISO8601Duration(s.timeGrain,s.timeGrainUnit)),r.groupBy&&!s.dimension&&(s.dimension=[r.groupBy]),r.filter&&!s.dimensionFilter&&(s.dimensionFilter=r.filter),(0,a.isString)(s.dimension)&&("None"===s.dimension?s.dimension=[]:s.dimension=[s.dimension]),s.dimension||(s.dimension=[]);const i=(0,p.getTemplateSrv)();return{refId:e.refId,queryType:l.B.ApplicationInsights,appInsights:{timeGrain:i.replace((s.timeGrain||"").toString(),t),metricName:i.replace(s.metricName,t),aggregation:i.replace(s.aggregation,t),dimension:s.dimension.map((e=>i.replace(e,t))),dimensionFilter:i.replace(s.dimensionFilter,t),alias:s.alias}}}testDatasource(){const e=`${this.resourcePath}/metrics/metadata`;return this.getResource(e).then((e=>({status:"success",message:"Successfully queried the Application Insights service.",title:"Success"}))).catch((e=>{let t="Application Insights: ";return t+=e.statusText?e.statusText+": ":"",e.data&&e.data.error&&"PathNotFoundError"===e.data.error.code?t+="Invalid Application Id for Application Insights service.":e.data&&e.data.error?t+=e.data.error.code+". "+e.data.error.message:t+="Cannot connect to Application Insights REST API.",{status:"error",message:t}}))}getMetricNames(){const e=`${this.resourcePath}/metrics/metadata`;return this.getResource(e).then(A.parseMetricNames)}getMetricMetadata(e){const t=`${this.resourcePath}/metrics/metadata`;return this.getResource(t).then((t=>new A(t).parseMetadata(e)))}getGroupBys(e){return this.getMetricMetadata(e).then((e=>new A(e).parseGroupBys()))}getQuerySchema(){const e=`${this.resourcePath}/query/schema`;return this.getResource(e).then((e=>new A(e).parseQuerySchema()))}}class T{constructor(e,t,s){this.rawQueryString=e,this.options=t,this.defaultTimeField=s,this.rawQueryString=e,this.options=t,this.defaultTimeField=s}generate(){let e=this.rawQueryString;const t=/\$__([_a-zA-Z0-9]+)\(([^\)]*)\)/gi;e=e.replace(t,((e,t,s)=>"contains"===t?this.getMultiContains(s):e)),e=e.replace(/\$__escapeMulti\(('[^]*')\)/gi,((e,t)=>this.escape(t))),this.options&&(e=e.replace(t,((e,t,s)=>"timeFilter"===t?this.getTimeFilter(s,this.options):"timeFrom"===t?this.getFrom(this.options):"timeTo"===t?this.getUntil(this.options):e)),e=e.replace(/\$__interval/gi,this.options.interval));const s=e;e=encodeURIComponent(e);return{uriString:`query=${e}`,rawQuery:s}}getFrom(e){const t=e.range.from;return`datetime(${(0,r.dateTime)(t).startOf("minute").toISOString()})`}getUntil(e){var t;if("now"===(null===(t=e.rangeRaw)||void 0===t?void 0:t.to)){const e=Date.now();return`datetime(${(0,r.dateTime)(e).startOf("minute").toISOString()})`}{const t=e.range.to;return`datetime(${(0,r.dateTime)(t).startOf("minute").toISOString()})`}}getTimeFilter(e,t){var s;const r=e||this.defaultTimeField;return"now"===(null===(s=t.rangeRaw)||void 0===s?void 0:s.to)?`${r} >= ${this.getFrom(t)}`:`${r}  >= ${this.getFrom(t)} and ${r} <= ${this.getUntil(t)}`}getMultiContains(e){const t=e.indexOf(","),s=e.substring(0,t),r=e.substring(e.indexOf(",")+1);return r&&"all"===r.toLowerCase().trim()?"1 == 1":`${s.trim()} in (${r.trim()})`}escape(e){return e.substring(1,e.length-1).split("','").map((e=>`@'${e}'`)).join(", ")}}class x{constructor(e){this.results=e,this.results=e}parseQueryResult(){let e=[],t=[];for(let s=0;s<this.results.length;s++){if(0===this.results[s].result.tables.length)continue;t=this.results[s].result.tables[0].columns;const r=this.results[s].result.tables[0].rows;e="time_series"===this.results[s].query.resultFormat?(0,a.concat)(e,this.parseTimeSeriesResult(this.results[s].query,t,r)):(0,a.concat)(e,this.parseTableResult(this.results[s].query,t,r))}return e}parseTimeSeriesResult(e,t,s){const r=[];let i=-1,o=-1,n=-1;for(let e=0;e<t.length;e++)-1===i&&"datetime"===t[e].type&&(i=e),-1===o&&"string"===t[e].type&&(o=e),-1===n&&["int","long","real","double"].indexOf(t[e].type)>-1&&(n=e);if(-1===i)throw new Error("No datetime column found in the result. The Time Series format requires a time column.");return(0,a.forEach)(s,(s=>{const a=x.dateTimeToEpoch(s[i]),c=o>-1?s[o]:t[n].name,u=x.findOrCreateBucket(r,c);u.datapoints.push([s[n],a]),u.refId=e.refId,u.meta={executedQueryString:e.query}})),r}parseTableResult(e,t,s){return{type:"table",columns:(0,a.map)(t,(e=>({text:e.name,type:e.type}))),rows:s,refId:e.refId,meta:{executedQueryString:e.query}}}parseToVariables(){const e=this.parseQueryResult(),t=[];return(0,a.forEach)(e,(e=>{(0,a.forEach)((0,a.flattenDeep)(e.rows),(e=>{t.push({text:e,value:e})}))})),t}transformToAnnotations(e){const t=this.parseQueryResult(),s=[];return(0,a.forEach)(t,(t=>{let r=-1,i=-1,o=-1;for(let e=0;e<t.columns.length;e++)-1===r&&"datetime"===t.columns[e].type&&(r=e),-1===i&&"text"===t.columns[e].text.toLowerCase()&&(i=e),-1===o&&"tags"===t.columns[e].text.toLowerCase()&&(o=e);(0,a.forEach)(t.rows,(t=>{s.push({annotation:e.annotation,time:Math.floor(x.dateTimeToEpoch(t[r])),text:t[i]?t[i].toString():"",tags:t[o]?t[o].trim().split(/\s*,\s*/):[]})}))})),s}static findOrCreateBucket(e,t){let s=(0,a.find)(e,["target",t]);return s||(s={target:t,datapoints:[],refId:"",query:""},e.push(s)),s}static dateTimeToEpoch(e){return(0,r.dateTime)(e).valueOf()}static parseSubscriptions(e){const t=[];if(!e)return t;const s="subscriptionId";for(let r=0;r<e.value.length;r++)(0,a.find)(t,["value",(0,a.get)(e.value[r],s)])||t.push({text:`${(0,a.get)(e.value[r],"displayName")}`,value:(0,a.get)(e.value[r],s)});return t}}const z=/([\w\W]+):([\w]+)(?:\s?=\s?([\w\W]+))?/;function j(e){return e.functions?e.functions.map((e=>{const t=e.parameters&&e.parameters.split(", ").map((e=>{const t=e.match(z);if(!t)return;const[,s,r,a]=t;return{name:s,type:r,defaultValue:a,cslDefaultValue:a}})).filter((e=>!!e));return{name:e.name,body:e.body,inputParameters:t||[]}})):[]}var C=s("../../opt/drone/yarncache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/observable/from.js"),G=s("../../opt/drone/yarncache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/operators/mergeMap.js"),X=s("./public/app/plugins/datasource/grafana-azure-monitor-datasource/components/ResourcePicker/utils.ts");function R(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class q extends p.DataSourceWithBackend{constructor(e){super(e),R(this,"resourcePath",void 0),R(this,"azurePortalUrl",void 0),R(this,"defaultSubscriptionId",void 0),R(this,"azureMonitorPath",void 0),R(this,"firstWorkspace",void 0),R(this,"cache",void 0),this.instanceSettings=e,this.instanceSettings=e,this.cache=new Map,this.resourcePath=`${S.kr.logAnalytics}`,this.azureMonitorPath=`${S.kr.azureMonitor}/subscriptions`;const t=y(e);this.azurePortalUrl=f(t),this.defaultSubscriptionId=this.instanceSettings.jsonData.subscriptionId||""}isConfigured(){return!this.validateDatasource()}filterQuery(e){var t;return!0!==e.hide&&!(null===(t=e.azureLogAnalytics)||void 0===t||!t.query)&&!!e.azureLogAnalytics.resource}async getSubscriptions(){if(!this.isConfigured())return[];const e=`${this.azureMonitorPath}?api-version=2019-03-01`;return await this.getResource(e).then((e=>x.parseSubscriptions(e)))}async getWorkspaces(e){const t=await this.getWorkspaceList(e);return(0,a.map)(t.value,(e=>({text:e.name,value:e.id})))||[]}getWorkspaceList(e){const t=(0,p.getTemplateSrv)().replace(e||this.defaultSubscriptionId),s=this.azureMonitorPath+`/${t}/providers/Microsoft.OperationalInsights/workspaces?api-version=2017-04-26-preview`;return this.getResource(s)}async getMetadata(e){const t=`${this.resourcePath}/v1${e}/metadata`;return await this.getResource(t)}async getKustoSchema(e){return function(e,t){const s={name:t,tables:e.tables,functions:j(e),majorVersion:0,minorVersion:0};return{clusterType:"Engine",cluster:{connectionString:t,databases:[s]},database:s}}(await this.getMetadata(e),e)}applyTemplateVariables(e,t){const s=e.azureLogAnalytics;if(!s)return e;const r=(0,p.getTemplateSrv)(),a=r.replace(s.resource,t);let i=r.replace(s.workspace,t);i||a||!this.firstWorkspace||(i=this.firstWorkspace);const o=r.replace(s.query,t,S.Ll);return{refId:e.refId,queryType:l.B.LogAnalytics,azureLogAnalytics:{resultFormat:s.resultFormat,query:o,resource:a,workspace:i}}}query(e){return super.query(e).pipe((0,G.z)((e=>(0,C.Dp)(this.processResponse(e)))))}async processResponse(e){if(e.data)for(const r of e.data){var t,s;const e=null===(t=r.meta)||void 0===t||null===(s=t.custom)||void 0===s?void 0:s.encodedQuery;if(e&&e.length>0){const e=await this.buildDeepLink(r.meta.custom);if(null!=e&&e.length)for(const t of r.fields)t.config.links=[{url:e,title:"View in Azure Portal",targetBlank:!0}]}}return e}async buildDeepLink(e){const t=encodeURIComponent(e.encodedQuery),s=e.workspace,r=e.subscription,a=await this.getWorkspaceDetails(s);if(!a.workspace||!a.resourceGroup)return"";return`${this.azurePortalUrl}/#blade/Microsoft_OperationsManagementSuite_Workspace/AnalyticsBlade/initiator/AnalyticsShareLinkToQuery/isQueryEditorVisible/true/scope/%7B%22resources%22%3A%5B%7B%22resourceId%22%3A%22%2Fsubscriptions%2F${r}%2Fresourcegroups%2F${a.resourceGroup}%2Fproviders%2Fmicrosoft.operationalinsights%2Fworkspaces%2F${a.workspace}%22%7D%5D%7D/query/${t}/isQueryBase64Compressed/true/timespanInIsoFormat/P1D`}async getWorkspaceDetails(e){if(!this.defaultSubscriptionId)return{};const t=(await this.getWorkspaceList(this.defaultSubscriptionId)).value.find((t=>t.properties.customerId===e));if(!t)return{};const s=/.*resourcegroups\/(.*)\/providers.*/.exec(t.id);return!s||s.length<2?{}:{workspace:t.name,resourceGroup:s[1]}}getDeprecatedDefaultWorkSpace(){return this.instanceSettings.jsonData.logAnalyticsDefaultWorkspace}buildQuery(e,t,s){const r=new T((0,p.getTemplateSrv)().replace(e,{},S.Ll),t,"TimeGenerated").generate().uriString,a=(0,X.uD)(s)?`${this.resourcePath}/v1/workspaces/${s}/query?${r}`:`${this.resourcePath}/v1${s}/query?${r}`;return[{datasource:this.getRef(),path:a,resultFormat:"table"}]}async getDefaultOrFirstSubscription(){var e;if(this.defaultSubscriptionId)return this.defaultSubscriptionId;return null===(e=(await this.getSubscriptions())[0])||void 0===e?void 0:e.value}async getFirstWorkspace(){var e;if(this.firstWorkspace)return this.firstWorkspace;const t=await this.getDefaultOrFirstSubscription();if(!t)return;const s=null===(e=(await this.getWorkspaces(t))[0])||void 0===e?void 0:e.value;return s&&(this.firstWorkspace=s),s}annotationQuery(e){if(!e.annotation.rawQuery)return Promise.reject({message:"Query missing in annotation definition"});const t=this.buildQuery(e.annotation.rawQuery,e,e.annotation.workspace),s=this.doQueries(t);return Promise.all(s).then((t=>new x(t).transformToAnnotations(e)))}doQueries(e){return(0,a.map)(e,(e=>this.getResource(e.path).then((t=>({result:t,query:e}))).catch((t=>{throw{error:t,query:e}}))))}async testDatasource(){const e=this.validateDatasource();if(e)return e;let t;try{const e=await this.getFirstWorkspace();if(!e)return{status:"error",message:"Workspace not found."};t=e}catch(e){let t="Azure Log Analytics requires access to Azure Monitor but had the following error: ";return{status:"error",message:this.getErrorMessage(t,e)}}try{const e=(0,X.uD)(t)?`${this.resourcePath}/v1/workspaces/${t}/metadata`:`${this.resourcePath}/v1${t}/metadata`;return await this.getResource(e).then((e=>({status:"success",message:"Successfully queried the Azure Log Analytics service.",title:"Success"})))}catch(e){let t="Azure Log Analytics: ";return{status:"error",message:this.getErrorMessage(t,e)}}}getErrorMessage(e,t){return e+=t.statusText?t.statusText+": ":"",t.data&&t.data.error&&t.data.error.code?e+=t.data.error.code+". "+t.data.error.message:t.data&&t.data.error?e+=t.data.error:t.data?e+=t.data:e+="Cannot connect to Azure Log Analytics REST API.",e}validateDatasource(){if("clientsecret"===m(this.instanceSettings)){if(!this.isValidConfigField(this.instanceSettings.jsonData.tenantId))return{status:"error",message:"The Tenant Id field is required."};if(!this.isValidConfigField(this.instanceSettings.jsonData.clientId))return{status:"error",message:"The Client Id field is required."}}}isValidConfigField(e){return"string"==typeof e&&e.length>0}}var F=s("./public/app/plugins/datasource/grafana-azure-monitor-datasource/resourcePicker/resourcePickerData.ts"),Q=s("../../opt/drone/yarncache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/observable/forkJoin.js"),P=s("../../opt/drone/yarncache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/observable/of.js"),V=s("./public/app/features/templating/template_srv.ts");class B extends k{constructor(e){super(e)}applyTemplateVariables(e,t){const s=e.insightsAnalytics;if(!s)return e;const r=s.rawQueryString&&!s.query?s.rawQueryString:s.query;return{refId:e.refId,queryType:l.B.InsightsAnalytics,insightsAnalytics:{query:(0,p.getTemplateSrv)().replace(r,t),resultFormat:s.resultFormat}}}}var L=s("./public/app/plugins/datasource/grafana-azure-monitor-datasource/utils/migrateQuery.ts"),O=s("../../opt/drone/yarncache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/operators/map.js");class W extends p.DataSourceWithBackend{filterQuery(e){var t;return!(null===(t=e.azureResourceGraph)||void 0===t||!t.query)}applyTemplateVariables(e,t){const s=e.azureResourceGraph;if(!s)return e;const r=(0,p.getTemplateSrv)(),a=r.getVariables().map((e=>`$${e.name}`)),o=i().find(e.subscriptions,(e=>i().includes(a,e))),n=[...r.replace(o,t,(e=>e)).split(",").filter((e=>e.length>0)),...i().filter(e.subscriptions,(e=>!i().includes(a,e)))],c=r.replace(s.query,t,S.Ll);return{refId:e.refId,queryType:l.B.AzureResourceGraph,subscriptions:n,azureResourceGraph:{resultFormat:"table",query:c}}}}function $(e){var t,s,r,a,i;const o="string"==typeof e.rawQuery?e.rawQuery:null,n="string"==typeof e.workspace?e.workspace:null;if(!o||!n||null!==(t=e.target)&&void 0!==t&&null!==(s=t.azureLogAnalytics)&&void 0!==s&&s.query)return e;const c=Object.assign({},null!==(r=e.target)&&void 0!==r?r:{},{refId:null!==(a=null===(i=e.target)||void 0===i?void 0:i.refId)&&void 0!==a?a:"Anno",queryType:l.B.LogAnalytics,azureLogAnalytics:{query:o,resource:n}});return Object.assign({},e,{rawQuery:void 0,workspace:void 0,subscription:void 0,queryType:void 0,target:c})}var E=s("../../opt/drone/yarncache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/lastValueFrom.js"),U=s("./packages/grafana-ui/src/index.ts"),J=s("../../opt/drone/yarncache/react-npm-17.0.1-98658812fc-83b9df9529.zip/node_modules/react/index.js"),K=s("./public/app/plugins/datasource/grafana-azure-monitor-datasource/components/LogsQueryEditor/index.tsx"),_=s("./public/app/plugins/datasource/grafana-azure-monitor-datasource/utils/useLastError.ts"),H=s("./public/app/plugins/datasource/grafana-azure-monitor-datasource/components/Space.tsx");const Z=e=>({subscriptions:e.match(/^Subscriptions\(\)/i),resourceGroups:e.match(/^ResourceGroups\(\)/i),resourceGroupsWithSub:e.match(/^ResourceGroups\(([^\)]+?)(,\s?([^,]+?))?\)/i),metricDefinitions:e.match(/^Namespaces\(([^\)]+?)(,\s?([^,]+?))?\)/i),metricDefinitionsWithSub:e.match(/^Namespaces\(([^,]+?),\s?([^,]+?)\)/i),resourceNames:e.match(/^ResourceNames\(([^,]+?),\s?([^,]+?)\)/i),resourceNamesWithSub:e.match(/^ResourceNames\(([^,]+?),\s?([^,]+?),\s?(.+?)\)/i),metricNamespace:e.match(/^MetricNamespace\(([^,]+?),\s?([^,]+?),\s?([^,]+?)\)/i),metricNamespaceWithSub:e.match(/^metricnamespace\(([^,]+?),\s?([^,]+?),\s?([^,]+?),\s?([^,]+?)\)/i),metricNames:e.match(/^MetricNames\(([^,]+?),\s?([^,]+?),\s?([^,]+?),\s?([^,]+?)\)/i),metricNamesWithSub:e.match(/^MetricNames\(([^,]+?),\s?([^,]+?),\s?([^,]+?),\s?([^,]+?),\s?(.+?)\)/i),appInsightsMetricNameQuery:e.match(/^AppInsightsMetricNames\(\)/i),appInsightsGroupByQuery:e.match(/^AppInsightsGroupBys\(([^\)]+?)(,\s?([^,]+?))?\)/i),workspacesQuery:e.match(/^workspaces\(\)/i),workspacesQueryWithSub:e.match(/^workspaces\(["']?([^\)]+?)["']?\)/i)}),Y=async(e,t)=>"string"!=typeof e?e:(e=>{const t=Z(e);return Object.keys(t).some((e=>!!t[e]))})(e)?((e,t)=>{const s=Z(e),r=t.azureMonitorDatasource.defaultSubscriptionId;return{refId:"A",queryType:l.B.GrafanaTemplateVariableFn,grafanaTemplateVariableFn:s.appInsightsMetricNameQuery?{rawQuery:e,kind:"AppInsightsMetricNameQuery"}:s.appInsightsGroupByQuery?{kind:"AppInsightsGroupByQuery",rawQuery:e,metricName:s.appInsightsGroupByQuery[1]}:s.subscriptions?{kind:"SubscriptionsQuery",rawQuery:e}:s.resourceGroupsWithSub?{kind:"ResourceGroupsQuery",rawQuery:e,subscription:s.resourceGroupsWithSub[1]}:s.resourceGroups&&r?{kind:"ResourceGroupsQuery",rawQuery:e,subscription:r}:s.metricDefinitionsWithSub?{kind:"MetricDefinitionsQuery",rawQuery:e,subscription:s.metricDefinitionsWithSub[1],resourceGroup:s.metricDefinitionsWithSub[2]}:s.metricDefinitions&&r?{kind:"MetricDefinitionsQuery",rawQuery:e,subscription:r,resourceGroup:s.metricDefinitions[1]}:s.resourceNamesWithSub?{kind:"ResourceNamesQuery",rawQuery:e,subscription:s.resourceNamesWithSub[1],resourceGroup:s.resourceNamesWithSub[2],metricDefinition:s.resourceNamesWithSub[3]}:s.resourceNames&&r?{kind:"ResourceNamesQuery",rawQuery:e,subscription:r,resourceGroup:s.resourceNames[1],metricDefinition:s.resourceNames[2]}:s.metricNamespaceWithSub?{kind:"MetricNamespaceQuery",rawQuery:e,subscription:s.metricNamespaceWithSub[1],resourceGroup:s.metricNamespaceWithSub[2],metricDefinition:s.metricNamespaceWithSub[3],resourceName:s.metricNamespaceWithSub[4]}:s.metricNamespace&&r?{kind:"MetricNamespaceQuery",rawQuery:e,subscription:r,resourceGroup:s.metricNamespace[1],metricDefinition:s.metricNamespace[2],resourceName:s.metricNamespace[3]}:s.metricNames&&r&&-1===s.metricNames[3].indexOf(",")?{kind:"MetricNamesQuery",rawQuery:e,subscription:r,resourceGroup:s.metricNames[1],metricDefinition:s.metricNames[2],resourceName:s.metricNames[3],metricNamespace:s.metricNames[4]}:s.metricNamesWithSub?{kind:"MetricNamesQuery",rawQuery:e,subscription:s.metricNamesWithSub[1],resourceGroup:s.metricNamesWithSub[2],metricDefinition:s.metricNamesWithSub[3],resourceName:s.metricNamesWithSub[4],metricNamespace:s.metricNamesWithSub[5]}:s.workspacesQueryWithSub?{kind:"WorkspacesQuery",rawQuery:e,subscription:(s.workspacesQueryWithSub[1]||"").trim()}:s.workspacesQuery&&r?{kind:"WorkspacesQuery",rawQuery:e,subscription:r}:{kind:"SubscriptionsQuery",rawQuery:e},subscription:r}})(e,t.datasource):(async(e,t)=>{const s=t.azureMonitorDatasource.defaultSubscriptionId;let r="";if(e){const e=t.azureLogAnalyticsDatasource.getDeprecatedDefaultWorkSpace();r=e?(0,X.uD)(e)?await t.resourcePickerData.getResourceURIFromWorkspace(e):e:await t.azureLogAnalyticsDatasource.getFirstWorkspace()||""}return{refId:"A",queryType:l.B.LogAnalytics,azureLogAnalytics:{query:e,resource:r},subscription:s}})(e,t.datasource);var ee,te=s("../../opt/drone/yarncache/react-npm-17.0.1-98658812fc-83b9df9529.zip/node_modules/react/jsx-runtime.js");const se=[{label:"Grafana Query Function",value:l.B.GrafanaTemplateVariableFn},{label:"Logs",value:l.B.LogAnalytics}],re=({query:e,updateQuery:t,datasource:s})=>{var r;const[i,o]=(0,J.useState)("");(0,J.useEffect)((()=>{var t;o((null===(t=e.grafanaTemplateVariableFn)||void 0===t?void 0:t.rawQuery)||"")}),[null===(r=e.grafanaTemplateVariableFn)||void 0===r?void 0:r.rawQuery]);const n=(0,J.useCallback)((r=>{Y(r,{datasource:s}).then((s=>{s.queryType===l.B.GrafanaTemplateVariableFn?t(s):t(Object.assign({},e,{grafanaTemplateVariableFn:{kind:"UnknownQuery",rawQuery:r}}))}))}),[s,e,t]),c=(0,J.useMemo)((()=>(0,a.debounce)(n,500)),[n]);return(0,te.jsx)(U.InlineField,{label:"Grafana template variable function",children:(0,te.jsx)(U.Input,{placeholder:"type a grafana template variable function, ex: Subscriptions()",value:i,onChange:e=>{o(e.target.value),c(e.target.value)}})})},ae=e=>{const t={refId:"A",queryType:l.B.GrafanaTemplateVariableFn},[s,r]=(0,J.useState)(t);(0,J.useEffect)((()=>{Y(e.query,{datasource:e.datasource}).then((e=>{r(e)}))}),[e.query,e.datasource]);const[a,i]=(0,_.Z)();return(0,te.jsxs)(te.Fragment,{children:[(0,te.jsx)(U.InlineField,{label:"Select query type",children:(0,te.jsx)(U.Select,{"aria-label":"select query type",onChange:e=>{e.value&&r(Object.assign({},s,{queryType:e.value}))},options:se,width:25,value:s.queryType})}),s.queryType===l.B.LogAnalytics&&(0,te.jsxs)(te.Fragment,{children:[(0,te.jsx)(K.Z,{subscriptionId:s.subscription,query:s,datasource:e.datasource,onChange:t=>{var s;r(t),null!==(s=t.azureLogAnalytics)&&void 0!==s&&s.query&&e.onChange(t)},variableOptionGroup:{label:"Template Variables",options:[]},setError:i,hideFormatAs:!0}),a&&(0,te.jsxs)(te.Fragment,{children:[ee||(ee=(0,te.jsx)(H.T,{v:2})),(0,te.jsx)(U.Alert,{severity:"error",title:"An error occurred while requesting metadata from Azure Monitor",children:a})]})]}),s.queryType===l.B.GrafanaTemplateVariableFn&&(0,te.jsx)(re,{query:s,updateQuery:e.onChange,datasource:e.datasource})]})};class ie extends r.CustomVariableSupport{constructor(e){var t,s,r;super(),r=ae,(s="editor")in(t=this)?Object.defineProperty(t,s,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[s]=r,this.datasource=e,this.datasource=e,this.datasource=e,this.query=this.query.bind(this)}query(e){return(0,C.Dp)((async()=>{const t=await Y(e.targets[0],{datasource:this.datasource});if(t.queryType===l.B.GrafanaTemplateVariableFn&&t.grafanaTemplateVariableFn){const e=await this.callGrafanaTemplateVariableFn(t.grafanaTemplateVariableFn);return{data:e?[(0,r.toDataFrame)(e)]:[]}}return e.targets[0]=t,(0,E.n)(this.datasource.query(e))})())}callGrafanaTemplateVariableFn(e){if(this.datasource.insightsAnalyticsDatasource){if("AppInsightsMetricNameQuery"===e.kind)return this.datasource.insightsAnalyticsDatasource.getMetricNames();if("AppInsightsGroupByQuery"===e.kind)return this.datasource.insightsAnalyticsDatasource.getGroupBys((0,p.getTemplateSrv)().replace(e.metricName))}return"SubscriptionsQuery"===e.kind?this.datasource.getSubscriptions():"ResourceGroupsQuery"===e.kind?this.datasource.getResourceGroups(this.replaceVariable(e.subscription)):"MetricDefinitionsQuery"===e.kind?this.datasource.getMetricDefinitions(this.replaceVariable(e.subscription),this.replaceVariable(e.resourceGroup)):"ResourceNamesQuery"===e.kind?this.datasource.getResourceNames(this.replaceVariable(e.subscription),this.replaceVariable(e.resourceGroup),this.replaceVariable(e.metricDefinition)):"MetricNamespaceQuery"===e.kind?this.datasource.getMetricNamespaces(this.replaceVariable(e.subscription),this.replaceVariable(e.resourceGroup),this.replaceVariable(e.metricDefinition),this.replaceVariable(e.resourceName)):"MetricNamesQuery"===e.kind?this.datasource.getMetricNames(this.replaceVariable(e.subscription),this.replaceVariable(e.resourceGroup),this.replaceVariable(e.metricDefinition),this.replaceVariable(e.resourceName),this.replaceVariable(e.metricNamespace)):"WorkspacesQuery"===e.kind?this.datasource.azureLogAnalyticsDatasource.getWorkspaces(this.replaceVariable(e.subscription)):null}replaceVariable(e){return(0,p.getTemplateSrv)().replace((e||"").trim())}}function oe(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class ne extends r.DataSourceApi{constructor(e,t=(0,V.J)()){super(e),oe(this,"annotations",{prepareAnnotation:$}),oe(this,"azureMonitorDatasource",void 0),oe(this,"azureLogAnalyticsDatasource",void 0),oe(this,"resourcePickerData",void 0),oe(this,"azureResourceGraphDatasource",void 0),oe(this,"appInsightsDatasource",void 0),oe(this,"insightsAnalyticsDatasource",void 0),oe(this,"pseudoDatasource",{}),this.templateSrv=t,this.templateSrv=t,this.azureMonitorDatasource=new I(e),this.azureLogAnalyticsDatasource=new q(e),this.azureResourceGraphDatasource=new W(e),this.resourcePickerData=new F.Z(e),this.pseudoDatasource={[l.B.AzureMonitor]:this.azureMonitorDatasource,[l.B.LogAnalytics]:this.azureLogAnalyticsDatasource,[l.B.AzureResourceGraph]:this.azureResourceGraphDatasource};const s=y(e);"azuremonitor"!==s&&"chinaazuremonitor"!==s||(this.appInsightsDatasource=new k(e),this.insightsAnalyticsDatasource=new B(e),this.pseudoDatasource[l.B.ApplicationInsights]=this.appInsightsDatasource,this.pseudoDatasource[l.B.InsightsAnalytics]=this.insightsAnalyticsDatasource),this.variables=new ie(this)}filterQuery(e){var t,s;if(!e.queryType)return!0;const r=this.pseudoDatasource[e.queryType];return null===(t=null==r||null===(s=r.filterQuery)||void 0===s?void 0:s.call(r,e))||void 0===t||t}query(e){const t=new Map;for(const s of e.targets){const r=(0,L.N)(s);if(!r.queryType||r.hide||!ce(r))continue;if(!t.has(r.queryType)){const s=(0,a.cloneDeep)(e);s.requestId=`${s.requestId}-${r.refId}`,s.targets=[],t.set(r.queryType,s)}const i=t.get(r.queryType);null==i||i.targets.push(r)}const s=Array.from(t.entries()).map((([e,t])=>{const s=this.pseudoDatasource[e];if(!s)throw new Error("Data source not created for query type "+e);return s.query(t)}));return 1===s.length?s[0]:s.length>1?(0,Q.D)(s).pipe((0,O.U)((e=>{const t=[];for(const s of e)for(const e of s.data)t.push(e);return{state:r.LoadingState.Done,data:t}}))):(0,P.of)({state:r.LoadingState.Done,data:[]})}targetContainsTemplate(e){if(e.subscription&&this.templateSrv.variableExists(e.subscription))return!0;let t;return e.queryType===l.B.AzureMonitor?t=JSON.stringify(e.azureMonitor):e.queryType===l.B.LogAnalytics?t=JSON.stringify(e.azureLogAnalytics):e.queryType===l.B.AzureResourceGraph&&(t=JSON.stringify([e.azureResourceGraph,e.subscriptions])),!!t&&this.templateSrv.variableExists(t)}async annotationQuery(e){return this.azureLogAnalyticsDatasource.annotationQuery(e)}async testDatasource(){var e;const t=[];return t.push(this.azureMonitorDatasource.testDatasource()),t.push(this.azureLogAnalyticsDatasource.testDatasource()),null!==(e=this.appInsightsDatasource)&&void 0!==e&&e.isConfigured()&&t.push(this.appInsightsDatasource.testDatasource()),await Promise.all(t).then((e=>{let t="success",s="";for(let r=0;r<e.length;r++)"success"!==e[r].status&&(t=e[r].status),s+=`${r+1}. ${e[r].message} `;return{status:t,message:s,title:(0,a.upperFirst)(t)}}))}getResourceGroups(e){return this.azureMonitorDatasource.getResourceGroups(this.replaceTemplateVariable(e))}getMetricDefinitions(e,t){return this.azureMonitorDatasource.getMetricDefinitions(this.replaceTemplateVariable(e),this.replaceTemplateVariable(t))}getResourceNames(e,t,s){return this.azureMonitorDatasource.getResourceNames(this.replaceTemplateVariable(e),this.replaceTemplateVariable(t),this.replaceTemplateVariable(s))}getMetricNames(e,t,s,r,a){return this.azureMonitorDatasource.getMetricNames(this.replaceTemplateVariable(e),this.replaceTemplateVariable(t),this.replaceTemplateVariable(s),this.replaceTemplateVariable(r),this.replaceTemplateVariable(a))}getMetricNamespaces(e,t,s,r){return this.azureMonitorDatasource.getMetricNamespaces(this.replaceTemplateVariable(e),this.replaceTemplateVariable(t),this.replaceTemplateVariable(s),this.replaceTemplateVariable(r))}getMetricMetadata(e,t,s,r,a,i){return this.azureMonitorDatasource.getMetricMetadata(this.replaceTemplateVariable(e),this.replaceTemplateVariable(t),this.replaceTemplateVariable(s),this.replaceTemplateVariable(r),this.replaceTemplateVariable(a),this.replaceTemplateVariable(i))}getAppInsightsMetricNames(){var e;return null===(e=this.appInsightsDatasource)||void 0===e?void 0:e.getMetricNames()}getAppInsightsMetricMetadata(e){var t;return null===(t=this.appInsightsDatasource)||void 0===t?void 0:t.getMetricMetadata(e)}getAppInsightsColumns(e){var t;return null===(t=this.appInsightsDatasource)||void 0===t?void 0:t.logAnalyticsColumns[e]}getAzureLogAnalyticsWorkspaces(e){return this.azureLogAnalyticsDatasource.getWorkspaces(e)}getSubscriptions(){return this.azureMonitorDatasource.getSubscriptions()}interpolateVariablesInQueries(e,t){return e.map((e=>{var s;if(!e.queryType)return e;const r=this.pseudoDatasource[e.queryType];return null!==(s=null==r?void 0:r.applyTemplateVariables(e,t))&&void 0!==s?s:e}))}replaceTemplateVariable(e){return this.templateSrv.replace(e)}getVariables(){return this.templateSrv.getVariables().map((e=>`$${e.name}`))}isTemplateVariable(e){return this.getVariables().includes(e)}}function ce(e){switch(e.queryType){case l.B.AzureMonitor:return!!e.azureMonitor;case l.B.LogAnalytics:return!!e.azureLogAnalytics;case l.B.AzureResourceGraph:return!!e.azureResourceGraph;case l.B.GrafanaTemplateVariableFn:return!!e.grafanaTemplateVariableFn;case l.B.ApplicationInsights:return!!e.appInsights;case l.B.InsightsAnalytics:return!!e.insightsAnalytics;default:return!1}}var ue,le,pe,de,he,me,ge;const{Input:fe}=U.LegacyForms,ye=[{value:"msi",label:"Managed Identity"},{value:"clientsecret",label:"App Registration"}],ve=e=>{const{credentials:t,azureCloudOptions:s,onCredentialsChange:r,getSubscriptions:a,disabled:i}=e,o=function(e){switch(e.authType){case"msi":return!0;case"clientsecret":return!!(e.azureCloud&&e.tenantId&&e.clientId&&e.clientSecret)}}(t),[n,c]=(0,J.useState)([]),[u,l]=(0,J.useReducer)((e=>e+1),0);(0,J.useEffect)((()=>{if(!a||!o)return void p([]);let e=!1;return a().then((t=>{e||p(t,u)})),()=>{e=!0}}),[u]);const p=(e,s=!1)=>{if(c(e),a)if(s&&!t.defaultSubscriptionId&&e.length>0)d(e[0]);else if(t.defaultSubscriptionId){e.find((e=>e.value===t.defaultSubscriptionId))||d(void 0)}},d=e=>{if(r){const s=Object.assign({},t,{defaultSubscriptionId:null==e?void 0:e.value});r(s)}};return(0,te.jsxs)("div",{className:"gf-form-group",children:[e.managedIdentityEnabled&&(0,te.jsx)("div",{className:"gf-form-inline",children:(0,te.jsxs)("div",{className:"gf-form",children:[ue||(ue=(0,te.jsx)(U.InlineFormLabel,{className:"width-12",tooltip:"Choose the type of authentication to Azure services",children:"Authentication"})),(0,te.jsx)(U.Select,{menuShouldPortal:!0,className:"width-15",value:ye.find((e=>e.value===t.authType)),options:ye,onChange:e=>{if(r){c([]);const s=Object.assign({},t,{authType:e.value||"msi",defaultSubscriptionId:void 0});r(s)}},disabled:i})]})}),"clientsecret"===t.authType&&(0,te.jsxs)(te.Fragment,{children:[s&&(0,te.jsx)("div",{className:"gf-form-inline",children:(0,te.jsxs)("div",{className:"gf-form",children:[le||(le=(0,te.jsx)(U.InlineFormLabel,{className:"width-12",tooltip:"Choose an Azure Cloud",children:"Azure Cloud"})),(0,te.jsx)(U.Select,{"aria-label":"Azure Cloud",menuShouldPortal:!0,className:"width-15",value:s.find((e=>e.value===t.azureCloud)),options:s,onChange:e=>{if(r&&"clientsecret"===t.authType){c([]);const s=Object.assign({},t,{azureCloud:e.value,defaultSubscriptionId:void 0});r(s)}},disabled:i})]})}),(0,te.jsx)("div",{className:"gf-form-inline",children:(0,te.jsxs)("div",{className:"gf-form",children:[pe||(pe=(0,te.jsx)(U.InlineFormLabel,{className:"width-12",children:"Directory (tenant) ID"})),(0,te.jsx)("div",{className:"width-15",children:(0,te.jsx)(fe,{className:"width-30",placeholder:"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",value:t.tenantId||"",onChange:e=>{if(r&&"clientsecret"===t.authType){c([]);const s=Object.assign({},t,{tenantId:e.target.value,defaultSubscriptionId:void 0});r(s)}},disabled:i})})]})}),(0,te.jsx)("div",{className:"gf-form-inline",children:(0,te.jsxs)("div",{className:"gf-form",children:[de||(de=(0,te.jsx)(U.InlineFormLabel,{className:"width-12",children:"Application (client) ID"})),(0,te.jsx)("div",{className:"width-15",children:(0,te.jsx)(fe,{className:"width-30",placeholder:"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",value:t.clientId||"",onChange:e=>{if(r&&"clientsecret"===t.authType){c([]);const s=Object.assign({},t,{clientId:e.target.value,defaultSubscriptionId:void 0});r(s)}},disabled:i})})]})}),!i&&("symbol"==typeof t.clientSecret?(0,te.jsxs)("div",{className:"gf-form-inline",children:[he||(he=(0,te.jsxs)("div",{className:"gf-form",children:[(0,te.jsx)(U.InlineFormLabel,{className:"width-12",children:"Client Secret"}),(0,te.jsx)(fe,{"data-testid":"client-secret",className:"width-25",placeholder:"configured",disabled:!0})]})),(0,te.jsx)("div",{className:"gf-form",children:(0,te.jsx)("div",{className:"max-width-30 gf-form-inline",children:(0,te.jsx)(U.Button,{variant:"secondary",type:"button",onClick:()=>{if(r&&"clientsecret"===t.authType){c([]);const e=Object.assign({},t,{clientSecret:"",defaultSubscriptionId:void 0});r(e)}},disabled:i,children:"reset"})})})]}):(0,te.jsx)("div",{className:"gf-form-inline",children:(0,te.jsxs)("div",{className:"gf-form",children:[me||(me=(0,te.jsx)(U.InlineFormLabel,{className:"width-12",children:"Client Secret"})),(0,te.jsx)("div",{className:"width-15",children:(0,te.jsx)(fe,{className:"width-30",placeholder:"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",value:t.clientSecret||"",onChange:e=>{if(r&&"clientsecret"===t.authType){c([]);const s=Object.assign({},t,{clientSecret:e.target.value,defaultSubscriptionId:void 0});r(s)}},disabled:i})})]})}))]}),a&&(0,te.jsxs)(te.Fragment,{children:[(0,te.jsx)("div",{className:"gf-form-inline",children:(0,te.jsxs)("div",{className:"gf-form",children:[ge||(ge=(0,te.jsx)(U.InlineFormLabel,{className:"width-12",children:"Default Subscription"})),(0,te.jsx)("div",{className:"width-30",children:(0,te.jsx)(U.Select,{"aria-label":"Default Subscription",menuShouldPortal:!0,value:t.defaultSubscriptionId?n.find((e=>e.value===t.defaultSubscriptionId)):void 0,options:n,onChange:d,disabled:i})})]})}),!i&&(0,te.jsx)("div",{className:"gf-form-inline",children:(0,te.jsx)("div",{className:"gf-form",children:(0,te.jsx)("div",{className:"max-width-30 gf-form-inline",children:(0,te.jsx)(U.Button,{variant:"secondary",size:"sm",type:"button",onClick:l,disabled:!o,children:"Load Subscriptions"})})})})]}),e.children]})};var be;const Me=[{value:"azuremonitor",label:"Azure"},{value:"govazuremonitor",label:"Azure US Government"},{value:"germanyazuremonitor",label:"Azure Germany"},{value:"chinaazuremonitor",label:"Azure China"}],Se=e=>{const{updateOptions:t,getSubscriptions:s}=e,r=(0,J.useMemo)((()=>b(e.options)),[e.options]);return(0,te.jsxs)(te.Fragment,{children:[be||(be=(0,te.jsx)("h3",{className:"page-heading",children:"Authentication"})),(0,te.jsx)(ve,{managedIdentityEnabled:p.config.azure.managedIdentityEnabled,credentials:r,azureCloudOptions:Me,onCredentialsChange:e=>{t((t=>function(e,t){switch(t.authType){case"msi":if(!p.config.azure.managedIdentityEnabled)throw new Error("Managed Identity authentication is not enabled in Grafana config.");return Object.assign({},e,{jsonData:Object.assign({},e.jsonData,{azureAuthType:"msi",subscriptionId:t.defaultSubscriptionId})});case"clientsecret":return Object.assign({},e,{jsonData:Object.assign({},e.jsonData,{azureAuthType:"clientsecret",cloudName:t.azureCloud||g(),tenantId:t.tenantId,clientId:t.clientId,subscriptionId:t.defaultSubscriptionId}),secureJsonData:Object.assign({},e.secureJsonData,{clientSecret:"string"==typeof t.clientSecret&&t.clientSecret.length>0?t.clientSecret:void 0}),secureJsonFields:Object.assign({},e.secureJsonFields,{clientSecret:"symbol"==typeof t.clientSecret})})}}(t,e)))},getSubscriptions:s,disabled:e.options.readOnly})]})};var we,Ne;const Ie=e=>{const{updateOptions:t}=e,s=(0,J.useMemo)((()=>b(e.options)),[e.options]);return"clientsecret"===s.authType&&!1===e.options.jsonData.azureLogAnalyticsSameAs?(0,te.jsxs)(te.Fragment,{children:[we||(we=(0,te.jsx)("h3",{className:"page-heading",children:"Azure Monitor Logs"})),(0,te.jsxs)(te.Fragment,{children:[Ne||(Ne=(0,te.jsx)(U.Alert,{severity:"error",title:"Deprecated",children:"Using different credentials for Azure Monitor Logs is no longer supported. Authentication information above will be used instead. Please create a new data source with the credentials below."})),(0,te.jsx)(ve,{managedIdentityEnabled:!1,credentials:Object.assign({},s,{authType:"clientsecret",tenantId:e.options.jsonData.logAnalyticsTenantId,clientId:e.options.jsonData.logAnalyticsClientId}),disabled:!0,children:(0,te.jsx)(U.Button,{onClick:()=>{t((e=>Object.assign({},e,{jsonData:Object.assign({},e.jsonData,{azureLogAnalyticsSameAs:!0})})))},children:"Clear Azure Monitor Logs Credentials"})})]})]}):null};var Ae,De,ke,Te,xe;const{Input:ze}=U.LegacyForms;class je extends J.PureComponent{constructor(...e){var t,s,r;super(...e),r=()=>{this.props.onResetOptionKey("appInsightsApiKey")},(s="onAppInsightsResetApiKey")in(t=this)?Object.defineProperty(t,s,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[s]=r}render(){const{options:e,onUpdateJsonDataOption:t,onUpdateSecureJsonDataOption:s}=this.props;return(0,te.jsxs)(te.Fragment,{children:[Ae||(Ae=(0,te.jsx)("h3",{className:"page-heading",children:"Azure Application Insights"})),De||(De=(0,te.jsx)(U.Alert,{severity:"info",title:"Application Insights credentials are deprecated",children:"Configure using Azure AD App Registration above and update existing queries to use Metrics or Logs."})),(0,te.jsxs)("div",{className:"gf-form-group",children:[e.secureJsonFields.appInsightsApiKey?(0,te.jsxs)("div",{className:"gf-form-inline",children:[ke||(ke=(0,te.jsxs)("div",{className:"gf-form",children:[(0,te.jsx)(U.InlineFormLabel,{className:"width-12",children:"API Key"}),(0,te.jsx)(ze,{className:"width-25",placeholder:"configured",disabled:!0})]})),(0,te.jsx)("div",{className:"gf-form",children:(0,te.jsx)("div",{className:"max-width-30 gf-form-inline",children:(0,te.jsx)(U.Button,{variant:"secondary",type:"button",onClick:this.onAppInsightsResetApiKey,disabled:this.props.options.readOnly,children:"reset"})})})]}):(0,te.jsx)("div",{className:"gf-form-inline",children:(0,te.jsxs)("div",{className:"gf-form",children:[Te||(Te=(0,te.jsx)(U.InlineFormLabel,{className:"width-12",children:"API Key"})),(0,te.jsx)("div",{className:"width-15",children:(0,te.jsx)(ze,{className:"width-30",placeholder:"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",value:e.secureJsonData.appInsightsApiKey||"",onChange:s("appInsightsApiKey"),disabled:this.props.options.readOnly})})]})}),(0,te.jsx)("div",{className:"gf-form-inline",children:(0,te.jsxs)("div",{className:"gf-form",children:[xe||(xe=(0,te.jsx)(U.InlineFormLabel,{className:"width-12",children:"Application ID"})),(0,te.jsx)("div",{className:"width-15",children:(0,te.jsx)(ze,{className:"width-30",value:e.jsonData.appInsightsAppId||"",onChange:t("appInsightsAppId"),disabled:this.props.options.readOnly})})]})})]})]})}}function Ce(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class Ge extends J.PureComponent{constructor(e){var t;super(e),Ce(this,"templateSrv",(0,p.getTemplateSrv)()),Ce(this,"baseURL",void 0),Ce(this,"updateOptions",(e=>{const t=e(this.props.options);this.props.onOptionsChange(t),this.setState({unsaved:!0})})),Ce(this,"saveOptions",(async()=>{this.state.unsaved&&(await(0,p.getBackendSrv)().put(`/api/datasources/${this.props.options.id}`,this.props.options).then((e=>{(0,r.updateDatasourcePluginOption)(this.props,"version",e.datasource.version)})),this.setState({unsaved:!1}))})),Ce(this,"getSubscriptions",(async()=>{await this.saveOptions();try{const e=await(0,p.getBackendSrv)().fetch({url:this.baseURL+"?api-version=2019-03-01",method:"GET"}).toPromise();return this.setState({error:void 0}),c.parseSubscriptionsForSelect(e)}catch(t){var e;return this.setState({error:{title:"Error requesting subscriptions",description:"Could not request subscriptions from Azure. Check your credentials and try again.",details:null==t||null===(e=t.data)||void 0===e?void 0:e.message}}),Promise.resolve([])}})),Ce(this,"onUpdateJsonDataOption",(e=>t=>{(0,r.updateDatasourcePluginJsonDataOption)(this.props,e,t.currentTarget.value)})),Ce(this,"onUpdateSecureJsonDataOption",(e=>t=>{(0,r.updateDatasourcePluginSecureJsonDataOption)(this.props,e,t.currentTarget.value)})),Ce(this,"resetSecureKey",(e=>{(0,r.updateDatasourcePluginResetOption)(this.props,e)})),this.state={unsaved:!1,appInsightsInitiallyConfigured:(t=e.options,!(!t.jsonData.appInsightsAppId||!t.secureJsonFields.appInsightsApiKey))},this.baseURL=`/api/datasources/${this.props.options.id}/resources/${S.kr.azureMonitor}/subscriptions`}render(){const{options:e}=this.props,{error:t}=this.state;return(0,te.jsxs)(te.Fragment,{children:[(0,te.jsx)(Se,{options:e,updateOptions:this.updateOptions,getSubscriptions:this.getSubscriptions}),(0,te.jsx)(Ie,{options:e,updateOptions:this.updateOptions}),this.state.appInsightsInitiallyConfigured&&(0,te.jsx)(je,{options:e,onUpdateJsonDataOption:this.onUpdateJsonDataOption,onUpdateSecureJsonDataOption:this.onUpdateSecureJsonDataOption,onResetOptionKey:this.resetSecureKey}),t&&(0,te.jsxs)(U.Alert,{severity:"error",title:t.title,children:[(0,te.jsx)("p",{children:t.description}),t.details&&(0,te.jsx)("details",{style:{whiteSpace:"pre-wrap"},children:t.details})]})]})}}var Xe=s("./public/app/plugins/datasource/grafana-azure-monitor-datasource/components/QueryEditor/QueryEditor.tsx");const Re=new r.DataSourcePlugin(ne).setConfigEditor(Ge).setQueryEditor(Xe.Z)}}]);
//# sourceMappingURL=azureMonitorPlugin.1f65f885c5a67f13d9d6.js.map