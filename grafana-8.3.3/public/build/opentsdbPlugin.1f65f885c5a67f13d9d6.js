"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[3168],{"./public/app/plugins/datasource/opentsdb/module.ts":(t,e,r)=>{r.r(e),r.d(e,{plugin:()=>A});var s=r("../../opt/drone/yarncache/angular-npm-1.8.2-307000482b-35ea81a23b.zip/node_modules/angular/index.js"),a=r.n(s),i=r("../../opt/drone/yarncache/lodash-npm-4.17.21-6382451519-eb835a2e51.zip/node_modules/lodash/lodash.js"),o=r("../../opt/drone/yarncache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/observable/of.js"),n=r("../../opt/drone/yarncache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/lastValueFrom.js"),l=r("../../opt/drone/yarncache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/operators/catchError.js"),g=r("../../opt/drone/yarncache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/operators/map.js"),u=r("./packages/grafana-runtime/src/index.ts"),h=r("./packages/grafana-data/src/index.ts"),c=r("./public/app/features/templating/template_srv.ts");function d(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}class p extends h.DataSourceApi{constructor(t,e=(0,c.J)()){super(t),d(this,"type",void 0),d(this,"url",void 0),d(this,"name",void 0),d(this,"withCredentials",void 0),d(this,"basicAuth",void 0),d(this,"tsdbVersion",void 0),d(this,"tsdbResolution",void 0),d(this,"lookupLimit",void 0),d(this,"tagKeys",void 0),d(this,"aggregatorsPromise",void 0),d(this,"filterTypesPromise",void 0),this.templateSrv=e,this.templateSrv=e,this.type="opentsdb",this.url=t.url,this.name=t.name,this.withCredentials=t.withCredentials,this.basicAuth=t.basicAuth,t.jsonData=t.jsonData||{},this.tsdbVersion=t.jsonData.tsdbVersion||1,this.tsdbResolution=t.jsonData.tsdbResolution||1,this.lookupLimit=t.jsonData.lookupLimit||1e3,this.tagKeys={},this.aggregatorsPromise=null,this.filterTypesPromise=null}query(t){const e=this.convertToTSDBTime(t.range.raw.from,!1,t.timezone),r=this.convertToTSDBTime(t.range.raw.to,!0,t.timezone),s=[];(0,i.each)(t.targets,(e=>{e.metric&&s.push(this.convertTargetToQuery(e,t,this.tsdbVersion))}));const a=(0,i.compact)(s);if((0,i.isEmpty)(a))return(0,o.of)({data:[]});const n={};return(0,i.each)(a,(t=>{t.filters&&t.filters.length>0?(0,i.each)(t.filters,(t=>{n[t.tagk]=!0})):(0,i.each)(t.tags,((t,e)=>{n[e]=!0}))})),t.targets=(0,i.filter)(t.targets,(t=>!0!==t.hide)),this.performTimeSeriesQuery(a,e,r).pipe((0,l.K)((t=>{var e,r;throw(null==t||null===(e=t.data)||void 0===e||null===(r=e.error)||void 0===r?void 0:r.message)||"Error performing time series query."})),(0,g.U)((e=>{const r=this.mapMetricsToTargets(e.data,t,this.tsdbVersion);return{data:(0,i.map)(e.data,((e,s)=>(-1===(s=r[s])&&(s=0),this._saveTagKeys(e),this.transformMetricData(e,n,t.targets[s],t,this.tsdbResolution))))}})))}annotationQuery(t){const e=this.convertToTSDBTime(t.rangeRaw.from,!1,t.timezone),r=this.convertToTSDBTime(t.rangeRaw.to,!0,t.timezone),s=[],a=[];s.push({aggregator:"sum",metric:t.annotation.target});const o=(0,i.compact)(s);return(0,n.n)(this.performTimeSeriesQuery(o,e,r).pipe((0,g.U)((e=>{if(e.data[0]){let r=e.data[0].annotations;t.annotation.isGlobal&&(r=e.data[0].globalAnnotations),r&&(0,i.each)(r,(e=>{const r={text:e.description,time:1e3*Math.floor(e.startTime),annotation:t.annotation};a.push(r)}))}return a}))))}targetContainsTemplate(t){if(t.filters&&t.filters.length>0)for(let e=0;e<t.filters.length;e++)if(this.templateSrv.variableExists(t.filters[e].filter))return!0;if(t.tags&&Object.keys(t.tags).length>0)for(const e in t.tags)if(this.templateSrv.variableExists(t.tags[e]))return!0;return!1}performTimeSeriesQuery(t,e,r){let s=!1;2===this.tsdbResolution&&(s=!0);const a={start:e,queries:t,msResolution:s,globalAnnotations:!0};3===this.tsdbVersion&&(a.showQuery=!0),r&&(a.end=r);const i={method:"POST",url:this.url+"/api/query",data:a};return this._addCredentialOptions(i),(0,u.getBackendSrv)().fetch(i)}suggestTagKeys(t){return Promise.resolve(this.tagKeys[t]||[])}_saveTagKeys(t){const e=Object.keys(t.tags);(0,i.each)(t.aggregateTags,(t=>{e.push(t)})),this.tagKeys[t.metric]=e}_performSuggestQuery(t,e){return this._get("/api/suggest",{type:e,q:t,max:this.lookupLimit}).pipe((0,g.U)((t=>t.data)))}_performMetricKeyValueLookup(t,e){if(!t||!e)return(0,o.of)([]);const r=e.split(",").map((t=>t.trim())),s=r[0];let a=s+"=*";r.length>1&&(a+=","+r.splice(1).join(","));const n=t+"{"+a+"}";return this._get("/api/search/lookup",{m:n,limit:this.lookupLimit}).pipe((0,g.U)((t=>{t=t.data.results;const e=[];return(0,i.each)(t,(t=>{-1===e.indexOf(t.tags[s])&&e.push(t.tags[s])})),e})))}_performMetricKeyLookup(t){return t?this._get("/api/search/lookup",{m:t,limit:1e3}).pipe((0,g.U)((t=>{t=t.data.results;const e=[];return(0,i.each)(t,(t=>{(0,i.each)(t.tags,((t,r)=>{-1===e.indexOf(r)&&e.push(r)}))})),e}))):(0,o.of)([])}_get(t,e){const r={method:"GET",url:this.url+t,params:e};return this._addCredentialOptions(r),(0,u.getBackendSrv)().fetch(r)}_addCredentialOptions(t){(this.basicAuth||this.withCredentials)&&(t.withCredentials=!0),this.basicAuth&&(t.headers={Authorization:this.basicAuth})}metricFindQuery(t){if(!t)return Promise.resolve([]);let e;try{e=this.templateSrv.replace(t,{},"distributed")}catch(t){return Promise.reject(t)}const r=t=>(0,i.map)(t,(t=>({text:t}))),s=e.match(/metrics\((.*)\)/);if(s)return(0,n.n)(this._performSuggestQuery(s[1],"metrics").pipe((0,g.U)(r)));const a=e.match(/tag_names\((.*)\)/);if(a)return(0,n.n)(this._performMetricKeyLookup(a[1]).pipe((0,g.U)(r)));const o=e.match(/tag_values\((.*?),\s?(.*)\)/);if(o)return(0,n.n)(this._performMetricKeyValueLookup(o[1],o[2]).pipe((0,g.U)(r)));const l=e.match(/suggest_tagk\((.*)\)/);if(l)return(0,n.n)(this._performSuggestQuery(l[1],"tagk").pipe((0,g.U)(r)));const u=e.match(/suggest_tagv\((.*)\)/);return u?(0,n.n)(this._performSuggestQuery(u[1],"tagv").pipe((0,g.U)(r))):Promise.resolve([])}testDatasource(){return(0,n.n)(this._performSuggestQuery("cpu","metrics").pipe((0,g.U)((()=>({status:"success",message:"Data source is working"})))))}getAggregators(){return this.aggregatorsPromise||(this.aggregatorsPromise=(0,n.n)(this._get("/api/aggregators").pipe((0,g.U)((t=>t.data&&(0,i.isArray)(t.data)?t.data.sort():[]))))),this.aggregatorsPromise}getFilterTypes(){return this.filterTypesPromise||(this.filterTypesPromise=(0,n.n)(this._get("/api/config/filters").pipe((0,g.U)((t=>t.data?Object.keys(t.data).sort():[]))))),this.filterTypesPromise}transformMetricData(t,e,r,s,a){const o=this.createMetricLabel(t,r,e,s),n=[];return(0,i.each)(t.dps,((t,e)=>{2===a?n.push([t,1*e]):n.push([t,1e3*e])})),{target:o,datapoints:n}}createMetricLabel(t,e,r,s){if(e.alias){const r=(0,i.clone)(s.scopedVars||{});return(0,i.each)(t.tags,((t,e)=>{r["tag_"+e]={value:t}})),this.templateSrv.replace(e.alias,r)}let a=t.metric;const o=[];return(0,i.isEmpty)(t.tags)||(0,i.each)((0,i.toPairs)(t.tags),(t=>{(0,i.has)(r,t[0])&&o.push(t[0]+"="+t[1])})),(0,i.isEmpty)(o)||(a+="{"+o.join(", ")+"}"),a}convertTargetToQuery(t,e,r){if(!t.metric||t.hide)return null;const s={metric:this.templateSrv.replace(t.metric,e.scopedVars,"pipe"),aggregator:"avg"};if(t.aggregator&&(s.aggregator=this.templateSrv.replace(t.aggregator)),t.shouldComputeRate&&(s.rate=!0,s.rateOptions={counter:!!t.isCounter},t.counterMax&&t.counterMax.length&&(s.rateOptions.counterMax=parseInt(t.counterMax,10)),t.counterResetValue&&t.counterResetValue.length&&(s.rateOptions.resetValue=parseInt(t.counterResetValue,10)),r>=2&&(s.rateOptions.dropResets=!(s.rateOptions.counterMax||s.rateOptions.ResetValue&&0!==s.rateOptions.ResetValue))),!t.disableDownsampling){let r=this.templateSrv.replace(t.downsampleInterval||e.interval);r.match(/\.[0-9]+s/)&&(r=1e3*parseFloat(r)+"ms"),s.downsample=r+"-"+t.downsampleAggregator,t.downsampleFillPolicy&&"none"!==t.downsampleFillPolicy&&(s.downsample+="-"+t.downsampleFillPolicy)}if(t.filters&&t.filters.length>0){if(s.filters=a().copy(t.filters),s.filters)for(const t in s.filters)s.filters[t].filter=this.templateSrv.replace(s.filters[t].filter,e.scopedVars,"pipe")}else if(s.tags=a().copy(t.tags),s.tags)for(const t in s.tags)s.tags[t]=this.templateSrv.replace(s.tags[t],e.scopedVars,"pipe");return t.explicitTags&&(s.explicitTags=!0),s}mapMetricsToTargets(t,e,r){let s,a;return(0,i.map)(t,(t=>3===r?t.query.index:(0,i.findIndex)(e.targets,(r=>r.filters&&r.filters.length>0?r.metric===t.metric:r.metric===t.metric&&(0,i.every)(r.tags,((r,o)=>(s=this.templateSrv.replace(r,e.scopedVars,"pipe"),a=s.split("|"),(0,i.includes)(a,t.tags[o])||"*"===s)))))))}interpolateVariablesInQueries(t,e){return t.length?t.map((t=>Object.assign({},t,{metric:this.templateSrv.replace(t.metric,e)}))):t}convertToTSDBTime(t,e,r){return"now"===t?null:(t=h.dateMath.parse(t,e,r)).valueOf()}}var m=r("./public/app/plugins/sdk.ts");function f(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}class v extends m.QueryCtrl{constructor(t,e){super(t,e),f(this,"aggregators",void 0),f(this,"fillPolicies",void 0),f(this,"filterTypes",void 0),f(this,"tsdbVersion",void 0),f(this,"aggregator",void 0),f(this,"downsampleInterval",void 0),f(this,"downsampleAggregator",void 0),f(this,"downsampleFillPolicy",void 0),f(this,"errors",void 0),f(this,"suggestMetrics",void 0),f(this,"suggestTagKeys",void 0),f(this,"suggestTagValues",void 0),f(this,"addTagMode",!1),f(this,"addFilterMode",!1),this.errors=this.validateTarget(),this.aggregators=["avg","sum","min","max","dev","zimsum","mimmin","mimmax"],this.fillPolicies=["none","nan","null","zero"],this.filterTypes=["wildcard","iliteral_or","not_iliteral_or","not_literal_or","iwildcard","literal_or","regexp"],this.tsdbVersion=this.datasource.tsdbVersion,this.target.aggregator||(this.target.aggregator="sum"),this.target.downsampleAggregator||(this.target.downsampleAggregator="avg"),this.target.downsampleFillPolicy||(this.target.downsampleFillPolicy="none"),this.datasource.getAggregators().then((t=>{0!==t.length&&(this.aggregators=t)})),this.datasource.getFilterTypes().then((t=>{0!==t.length&&(this.filterTypes=t)})),this.suggestMetrics=(t,e)=>{this.datasource.metricFindQuery("metrics("+t+")").then(this.getTextValues).then(e)},this.suggestTagKeys=(t,e)=>{this.datasource.suggestTagKeys(this.target.metric).then(e)},this.suggestTagValues=(t,e)=>{this.datasource.metricFindQuery("suggest_tagv("+t+")").then(this.getTextValues).then(e)}}targetBlur(){this.errors=this.validateTarget(),this.refresh()}getTextValues(t){return(0,i.map)(t,(t=>h.textUtil.escapeHtml(t.text)))}addTag(){this.target.filters&&this.target.filters.length>0&&(this.errors.tags="Please remove filters to use tags, tags and filters are mutually exclusive."),this.addTagMode?(this.target.tags||(this.target.tags={}),this.errors=this.validateTarget(),this.errors.tags||(this.target.tags[this.target.currentTagKey]=this.target.currentTagValue,this.target.currentTagKey="",this.target.currentTagValue="",this.targetBlur()),this.addTagMode=!1):this.addTagMode=!0}removeTag(t){delete this.target.tags[t],this.targetBlur()}editTag(t,e){this.removeTag(t),this.target.currentTagKey=t,this.target.currentTagValue=e,this.addTag()}closeAddTagMode(){this.addTagMode=!1}addFilter(){if(this.target.tags&&(0,i.size)(this.target.tags)>0&&(this.errors.filters="Please remove tags to use filters, tags and filters are mutually exclusive."),this.addFilterMode){if(this.target.filters||(this.target.filters=[]),this.target.currentFilterType||(this.target.currentFilterType="iliteral_or"),this.target.currentFilterGroupBy||(this.target.currentFilterGroupBy=!1),this.errors=this.validateTarget(),!this.errors.filters){const t={type:this.target.currentFilterType,tagk:this.target.currentFilterKey,filter:this.target.currentFilterValue,groupBy:this.target.currentFilterGroupBy};this.target.filters.push(t),this.target.currentFilterType="literal_or",this.target.currentFilterKey="",this.target.currentFilterValue="",this.target.currentFilterGroupBy=!1,this.targetBlur()}this.addFilterMode=!1}else this.addFilterMode=!0}removeFilter(t){this.target.filters.splice(t,1),this.targetBlur()}editFilter(t,e){this.removeFilter(e),this.target.currentFilterKey=t.tagk,this.target.currentFilterValue=t.filter,this.target.currentFilterType=t.type,this.target.currentFilterGroupBy=t.groupBy,this.addFilter()}closeAddFilterMode(){this.addFilterMode=!1}validateTarget(){const t={};if(this.target.shouldDownsample)try{this.target.downsampleInterval?h.rangeUtil.describeInterval(this.target.downsampleInterval):t.downsampleInterval="You must supply a downsample interval (e.g. '1m' or '1h')."}catch(e){t.downsampleInterval=e.message}return this.target.tags&&(0,i.has)(this.target.tags,this.target.currentTagKey)&&(t.tags="Duplicate tag key '"+this.target.currentTagKey+"'."),t}}v.$inject=["$scope","$injector"],f(v,"templateUrl","partials/query.editor.html");r("../../opt/drone/yarncache/react-npm-17.0.1-98658812fc-83b9df9529.zip/node_modules/react/index.js");var y,T,b,j,x=r("./packages/grafana-ui/src/index.ts"),F=r("../../opt/drone/yarncache/react-npm-17.0.1-98658812fc-83b9df9529.zip/node_modules/react/jsx-runtime.js");const{Select:w,Input:_}=x.LegacyForms,S=[{label:"<=2.1",value:1},{label:"==2.2",value:2},{label:"==2.3",value:3}],V=[{label:"second",value:1},{label:"millisecond",value:2}],k=t=>{var e,r,s;const{onChange:a,value:i}=t;return(0,F.jsxs)(F.Fragment,{children:[y||(y=(0,F.jsx)("h5",{children:"OpenTSDB settings"})),(0,F.jsxs)("div",{className:"gf-form",children:[T||(T=(0,F.jsx)(x.InlineFormLabel,{width:7,children:"Version"})),(0,F.jsx)(w,{menuShouldPortal:!0,options:S,value:null!==(e=S.find((t=>t.value===i.jsonData.tsdbVersion)))&&void 0!==e?e:S[0],onChange:P("tsdbVersion",i,a)})]}),(0,F.jsxs)("div",{className:"gf-form",children:[b||(b=(0,F.jsx)(x.InlineFormLabel,{width:7,children:"Resolution"})),(0,F.jsx)(w,{menuShouldPortal:!0,options:V,value:null!==(r=V.find((t=>t.value===i.jsonData.tsdbResolution)))&&void 0!==r?r:V[0],onChange:P("tsdbResolution",i,a)})]}),(0,F.jsxs)("div",{className:"gf-form",children:[j||(j=(0,F.jsx)(x.InlineFormLabel,{width:7,children:"Lookup limit"})),(0,F.jsx)(_,{type:"number",value:null!==(s=i.jsonData.lookupLimit)&&void 0!==s?s:1e3,onChange:M("lookupLimit",i,a)})]})]})},P=(t,e,r)=>s=>{r(Object.assign({},e,{jsonData:Object.assign({},e.jsonData,{[t]:s.value})}))},M=(t,e,r)=>s=>{r(Object.assign({},e,{jsonData:Object.assign({},e.jsonData,{[t]:s.currentTarget.value})}))};class D{}var O,C,K;K="partials/annotations.editor.html",(C="templateUrl")in(O=D)?Object.defineProperty(O,C,{value:K,enumerable:!0,configurable:!0,writable:!0}):O[C]=K;const A=new h.DataSourcePlugin(p).setQueryCtrl(v).setConfigEditor((t=>{const{options:e,onOptionsChange:r}=t;return(0,F.jsxs)(F.Fragment,{children:[(0,F.jsx)(x.DataSourceHttpSettings,{defaultUrl:"http://localhost:4242",dataSourceConfig:e,onChange:r}),(0,F.jsx)(k,{value:e,onChange:r})]})})).setAnnotationQueryCtrl(D)}}]);
//# sourceMappingURL=opentsdbPlugin.1f65f885c5a67f13d9d6.js.map