{"version":3,"file":"mssqlPlugin.1f65f885c5a67f13d9d6.js","mappings":"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","sources":["webpack://grafana/./public/app/features/datasources/utils/passwordHandlers.ts","webpack://grafana/./public/app/plugins/datasource/mssql/response_parser.ts","webpack://grafana/./public/app/plugins/datasource/mssql/datasource.ts","webpack://grafana/./public/app/plugins/datasource/mssql/query_ctrl.ts","webpack://grafana/./public/app/plugins/datasource/mssql/config_ctrl.ts","webpack://grafana/./public/app/plugins/datasource/mssql/module.ts"],"sourcesContent":["/**\n * Set of handlers for secure password field in Angular components. They handle backward compatibility with\n * passwords stored in plain text fields.\n */\n\nimport { SyntheticEvent } from 'react';\n\nexport enum PasswordFieldEnum {\n  Password = 'password',\n  BasicAuthPassword = 'basicAuthPassword',\n}\n\n/**\n * Basic shape for settings controllers in at the moment mostly angular data source plugins.\n */\nexport type Ctrl = {\n  current: {\n    secureJsonFields: {\n      [key: string]: boolean;\n    };\n    secureJsonData?: {\n      [key: string]: string;\n    };\n    password?: string;\n    basicAuthPassword?: string;\n  };\n};\n\nexport const createResetHandler = (ctrl: Ctrl, field: PasswordFieldEnum) => (\n  event: SyntheticEvent<HTMLInputElement>\n) => {\n  event.preventDefault();\n  // Reset also normal plain text password to remove it and only save it in secureJsonData.\n  ctrl.current[field] = undefined;\n  ctrl.current.secureJsonFields[field] = false;\n  ctrl.current.secureJsonData = ctrl.current.secureJsonData || {};\n  ctrl.current.secureJsonData[field] = '';\n};\n\nexport const createChangeHandler = (ctrl: any, field: PasswordFieldEnum) => (\n  event: SyntheticEvent<HTMLInputElement>\n) => {\n  ctrl.current.secureJsonData = ctrl.current.secureJsonData || {};\n  ctrl.current.secureJsonData[field] = event.currentTarget.value;\n};\n","import { AnnotationEvent, DataFrame, MetricFindValue } from '@grafana/data';\nimport { BackendDataSourceResponse, toDataQueryResponse, FetchResponse } from '@grafana/runtime';\n\nexport default class ResponseParser {\n  transformMetricFindResponse(raw: FetchResponse<BackendDataSourceResponse>): MetricFindValue[] {\n    const frames = toDataQueryResponse(raw).data as DataFrame[];\n\n    if (!frames || !frames.length) {\n      return [];\n    }\n\n    const frame = frames[0];\n\n    const values: MetricFindValue[] = [];\n    const textField = frame.fields.find((f) => f.name === '__text');\n    const valueField = frame.fields.find((f) => f.name === '__value');\n\n    if (textField && valueField) {\n      for (let i = 0; i < textField.values.length; i++) {\n        values.push({ text: '' + textField.values.get(i), value: '' + valueField.values.get(i) });\n      }\n    } else {\n      values.push(\n        ...frame.fields\n          .flatMap((f) => f.values.toArray())\n          .map((v) => ({\n            text: v,\n          }))\n      );\n    }\n\n    return Array.from(new Set(values.map((v) => v.text))).map((text) => ({\n      text,\n      value: values.find((v) => v.text === text)?.value,\n    }));\n  }\n\n  async transformAnnotationResponse(options: any, data: BackendDataSourceResponse): Promise<AnnotationEvent[]> {\n    const frames = toDataQueryResponse({ data: data }).data as DataFrame[];\n    if (!frames || !frames.length) {\n      return [];\n    }\n    const frame = frames[0];\n    const timeField = frame.fields.find((f) => f.name === 'time');\n\n    if (!timeField) {\n      return Promise.reject({ message: 'Missing mandatory time column (with time column alias) in annotation query.' });\n    }\n\n    const timeEndField = frame.fields.find((f) => f.name === 'timeend');\n    const textField = frame.fields.find((f) => f.name === 'text');\n    const tagsField = frame.fields.find((f) => f.name === 'tags');\n\n    const list: AnnotationEvent[] = [];\n    for (let i = 0; i < frame.length; i++) {\n      const timeEnd = timeEndField && timeEndField.values.get(i) ? Math.floor(timeEndField.values.get(i)) : undefined;\n      list.push({\n        annotation: options.annotation,\n        time: Math.floor(timeField.values.get(i)),\n        timeEnd,\n        text: textField && textField.values.get(i) ? textField.values.get(i) : '',\n        tags:\n          tagsField && tagsField.values.get(i)\n            ? tagsField.values\n                .get(i)\n                .trim()\n                .split(/\\s*,\\s*/)\n            : [],\n      });\n    }\n\n    return list;\n  }\n}\n","import { map as _map } from 'lodash';\nimport { lastValueFrom, of } from 'rxjs';\nimport { catchError, map, mapTo } from 'rxjs/operators';\nimport { BackendDataSourceResponse, DataSourceWithBackend, FetchResponse, getBackendSrv } from '@grafana/runtime';\nimport { AnnotationEvent, DataSourceInstanceSettings, MetricFindValue, ScopedVars } from '@grafana/data';\n\nimport ResponseParser from './response_parser';\nimport { getTemplateSrv, TemplateSrv } from 'app/features/templating/template_srv';\nimport { MssqlOptions, MssqlQuery, MssqlQueryForInterpolation } from './types';\nimport { getTimeSrv, TimeSrv } from 'app/features/dashboard/services/TimeSrv';\nimport { toTestingStatus } from '@grafana/runtime/src/utils/queryResponse';\n\nexport class MssqlDatasource extends DataSourceWithBackend<MssqlQuery, MssqlOptions> {\n  id: any;\n  name: any;\n  responseParser: ResponseParser;\n  interval: string;\n\n  constructor(\n    instanceSettings: DataSourceInstanceSettings<MssqlOptions>,\n    private readonly templateSrv: TemplateSrv = getTemplateSrv(),\n    private readonly timeSrv: TimeSrv = getTimeSrv()\n  ) {\n    super(instanceSettings);\n    this.name = instanceSettings.name;\n    this.id = instanceSettings.id;\n    this.responseParser = new ResponseParser();\n    const settingsData = instanceSettings.jsonData || ({} as MssqlOptions);\n    this.interval = settingsData.timeInterval || '1m';\n  }\n\n  interpolateVariable(value: any, variable: any) {\n    if (typeof value === 'string') {\n      if (variable.multi || variable.includeAll) {\n        return \"'\" + value.replace(/'/g, `''`) + \"'\";\n      } else {\n        return value;\n      }\n    }\n\n    if (typeof value === 'number') {\n      return value;\n    }\n\n    const quotedValues = _map(value, (val) => {\n      if (typeof value === 'number') {\n        return value;\n      }\n\n      return \"'\" + val.replace(/'/g, `''`) + \"'\";\n    });\n    return quotedValues.join(',');\n  }\n\n  interpolateVariablesInQueries(\n    queries: MssqlQueryForInterpolation[],\n    scopedVars: ScopedVars\n  ): MssqlQueryForInterpolation[] {\n    let expandedQueries = queries;\n    if (queries && queries.length > 0) {\n      expandedQueries = queries.map((query) => {\n        const expandedQuery = {\n          ...query,\n          datasource: this.getRef(),\n          rawSql: this.templateSrv.replace(query.rawSql, scopedVars, this.interpolateVariable),\n          rawQuery: true,\n        };\n        return expandedQuery;\n      });\n    }\n    return expandedQueries;\n  }\n\n  applyTemplateVariables(target: MssqlQuery, scopedVars: ScopedVars): Record<string, any> {\n    return {\n      refId: target.refId,\n      datasource: this.getRef(),\n      rawSql: this.templateSrv.replace(target.rawSql, scopedVars, this.interpolateVariable),\n      format: target.format,\n    };\n  }\n\n  async annotationQuery(options: any): Promise<AnnotationEvent[]> {\n    if (!options.annotation.rawQuery) {\n      return Promise.reject({ message: 'Query missing in annotation definition' });\n    }\n\n    const query = {\n      refId: options.annotation.name,\n      datasource: this.getRef(),\n      rawSql: this.templateSrv.replace(options.annotation.rawQuery, options.scopedVars, this.interpolateVariable),\n      format: 'table',\n    };\n\n    return lastValueFrom(\n      getBackendSrv()\n        .fetch<BackendDataSourceResponse>({\n          url: '/api/ds/query',\n          method: 'POST',\n          data: {\n            from: options.range.from.valueOf().toString(),\n            to: options.range.to.valueOf().toString(),\n            queries: [query],\n          },\n          requestId: options.annotation.name,\n        })\n        .pipe(\n          map(\n            async (res: FetchResponse<BackendDataSourceResponse>) =>\n              await this.responseParser.transformAnnotationResponse(options, res.data)\n          )\n        )\n    );\n  }\n\n  filterQuery(query: MssqlQuery): boolean {\n    return !query.hide;\n  }\n\n  metricFindQuery(query: string, optionalOptions: any): Promise<MetricFindValue[]> {\n    let refId = 'tempvar';\n    if (optionalOptions && optionalOptions.variable && optionalOptions.variable.name) {\n      refId = optionalOptions.variable.name;\n    }\n\n    const range = this.timeSrv.timeRange();\n\n    const interpolatedQuery = {\n      refId: refId,\n      datasource: this.getRef(),\n      rawSql: this.templateSrv.replace(query, {}, this.interpolateVariable),\n      format: 'table',\n    };\n\n    return lastValueFrom(\n      getBackendSrv()\n        .fetch<BackendDataSourceResponse>({\n          url: '/api/ds/query',\n          method: 'POST',\n          data: {\n            from: range.from.valueOf().toString(),\n            to: range.to.valueOf().toString(),\n            queries: [interpolatedQuery],\n          },\n          requestId: refId,\n        })\n        .pipe(\n          map((rsp) => {\n            return this.responseParser.transformMetricFindResponse(rsp);\n          }),\n          catchError((err) => {\n            return of([]);\n          })\n        )\n    );\n  }\n\n  testDatasource(): Promise<any> {\n    return lastValueFrom(\n      getBackendSrv()\n        .fetch({\n          url: '/api/ds/query',\n          method: 'POST',\n          data: {\n            from: '5m',\n            to: 'now',\n            queries: [\n              {\n                refId: 'A',\n                intervalMs: 1,\n                maxDataPoints: 1,\n                datasource: this.getRef(),\n                rawSql: 'SELECT 1',\n                format: 'table',\n              },\n            ],\n          },\n        })\n        .pipe(\n          mapTo({ status: 'success', message: 'Database Connection OK' }),\n          catchError((err) => {\n            return of(toTestingStatus(err));\n          })\n        )\n    );\n  }\n\n  targetContainsTemplate(query: MssqlQuery): boolean {\n    const rawSql = query.rawSql.replace('$__', '');\n    return this.templateSrv.variableExists(rawSql);\n  }\n}\n","import { QueryCtrl } from 'app/plugins/sdk';\nimport { auto } from 'angular';\nimport { PanelEvents, QueryResultMeta } from '@grafana/data';\nimport { MssqlQuery } from './types';\n\nconst defaultQuery = `SELECT\n  $__timeEpoch(<time_column>),\n  <value column> as value,\n  <series name column> as metric\nFROM\n  <table name>\nWHERE\n  $__timeFilter(time_column)\nORDER BY\n  <time_column> ASC`;\n\nexport class MssqlQueryCtrl extends QueryCtrl<MssqlQuery> {\n  static templateUrl = 'partials/query.editor.html';\n\n  formats: any[];\n  lastQueryMeta?: QueryResultMeta;\n  lastQueryError?: string;\n  showHelp = false;\n\n  /** @ngInject */\n  constructor($scope: any, $injector: auto.IInjectorService) {\n    super($scope, $injector);\n\n    this.target.format = this.target.format || 'time_series';\n    this.target.alias = '';\n    this.formats = [\n      { text: 'Time series', value: 'time_series' },\n      { text: 'Table', value: 'table' },\n    ];\n\n    if (!this.target.rawSql) {\n      // special handling when in table panel\n      if (this.panelCtrl.panel.type === 'table') {\n        this.target.format = 'table';\n        this.target.rawSql = 'SELECT 1';\n      } else {\n        this.target.rawSql = defaultQuery;\n      }\n    }\n\n    this.panelCtrl.events.on(PanelEvents.dataReceived, this.onDataReceived.bind(this), $scope);\n    this.panelCtrl.events.on(PanelEvents.dataError, this.onDataError.bind(this), $scope);\n  }\n\n  onDataReceived(dataList: any) {\n    this.lastQueryError = undefined;\n    this.lastQueryMeta = dataList[0]?.meta;\n  }\n\n  onDataError(err: any) {\n    if (err.data && err.data.results) {\n      const queryRes = err.data.results[this.target.refId];\n      if (queryRes) {\n        this.lastQueryError = queryRes.error;\n      }\n    }\n  }\n}\n","import {\n  createChangeHandler,\n  createResetHandler,\n  PasswordFieldEnum,\n} from '../../../features/datasources/utils/passwordHandlers';\n\nexport class MssqlConfigCtrl {\n  static templateUrl = 'partials/config.html';\n\n  // Set through angular bindings\n  declare current: any;\n\n  onPasswordReset: ReturnType<typeof createResetHandler>;\n  onPasswordChange: ReturnType<typeof createChangeHandler>;\n  showUserCredentials: boolean;\n\n  /** @ngInject */\n  constructor($scope: any) {\n    this.current = $scope.ctrl.current;\n    this.current.jsonData.encrypt = this.current.jsonData.encrypt || 'false';\n    this.current.jsonData.authenticationType = this.current.jsonData.authenticationType || 'SQL Server Authentication';\n    this.onPasswordReset = createResetHandler(this, PasswordFieldEnum.Password);\n    this.onPasswordChange = createChangeHandler(this, PasswordFieldEnum.Password);\n    this.showUserCredentials = this.current.jsonData.authenticationType !== 'Windows Authentication';\n  }\n\n  onAuthenticationTypeChange() {\n    // This is using the fallback in https://github.com/denisenkom/go-mssqldb to use Windows Auth if login/user id is empty.\n    if (this.current.jsonData.authenticationType === 'Windows Authentication') {\n      this.current.user = '';\n      this.current.password = '';\n    }\n\n    this.showUserCredentials = this.current.jsonData.authenticationType !== 'Windows Authentication';\n  }\n}\n","import { MssqlDatasource } from './datasource';\nimport { MssqlQueryCtrl } from './query_ctrl';\nimport { MssqlConfigCtrl } from './config_ctrl';\nimport { MssqlQuery } from './types';\nimport { DataSourcePlugin } from '@grafana/data';\n\nconst defaultQuery = `SELECT\n    <time_column> as time,\n    <text_column> as text,\n    <tags_column> as tags\n  FROM\n    <table name>\n  WHERE\n    $__timeFilter(time_column)\n  ORDER BY\n    <time_column> ASC`;\n\nclass MssqlAnnotationsQueryCtrl {\n  static templateUrl = 'partials/annotations.editor.html';\n\n  declare annotation: any;\n\n  /** @ngInject */\n  constructor($scope: any) {\n    this.annotation = $scope.ctrl.annotation;\n    this.annotation.rawQuery = this.annotation.rawQuery || defaultQuery;\n  }\n}\n\nexport const plugin = new DataSourcePlugin<MssqlDatasource, MssqlQuery>(MssqlDatasource)\n  .setQueryCtrl(MssqlQueryCtrl)\n  .setConfigCtrl(MssqlConfigCtrl)\n  .setAnnotationQueryCtrl(MssqlAnnotationsQueryCtrl);\n"],"names":["PasswordFieldEnum","createResetHandler","ctrl","field","event","preventDefault","current","undefined","secureJsonFields","secureJsonData","createChangeHandler","currentTarget","value","ResponseParser","transformMetricFindResponse","raw","frames","toDataQueryResponse","data","length","frame","values","textField","fields","find","f","name","valueField","i","push","text","get","flatMap","toArray","map","v","Array","from","Set","options","timeField","Promise","reject","message","timeEndField","tagsField","list","timeEnd","Math","floor","annotation","time","tags","trim","split","MssqlDatasource","DataSourceWithBackend","constructor","instanceSettings","templateSrv","getTemplateSrv","timeSrv","getTimeSrv","super","this","id","responseParser","settingsData","jsonData","interval","timeInterval","interpolateVariable","variable","multi","includeAll","replace","_map","val","join","interpolateVariablesInQueries","queries","scopedVars","expandedQueries","query","datasource","getRef","rawSql","rawQuery","applyTemplateVariables","target","refId","format","lastValueFrom","getBackendSrv","fetch","url","method","range","valueOf","toString","to","requestId","pipe","async","transformAnnotationResponse","res","filterQuery","hide","metricFindQuery","optionalOptions","timeRange","interpolatedQuery","rsp","catchError","err","of","testDatasource","intervalMs","maxDataPoints","mapTo","status","toTestingStatus","targetContainsTemplate","variableExists","MssqlQueryCtrl","QueryCtrl","$scope","$injector","alias","formats","panelCtrl","panel","type","events","on","PanelEvents","onDataReceived","bind","onDataError","dataList","lastQueryError","lastQueryMeta","meta","results","queryRes","error","MssqlConfigCtrl","encrypt","authenticationType","onPasswordReset","onPasswordChange","showUserCredentials","onAuthenticationTypeChange","user","password","MssqlAnnotationsQueryCtrl","plugin","DataSourcePlugin","setQueryCtrl","setConfigCtrl","setAnnotationQueryCtrl"],"sourceRoot":""}