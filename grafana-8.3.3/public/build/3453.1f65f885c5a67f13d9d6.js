"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[3453],{"./public/app/features/query/components/QueryGroup.tsx":(e,t,s)=>{s.d(t,{D:()=>L});var i,n,a=s("../../opt/drone/yarncache/react-npm-17.0.1-98658812fc-83b9df9529.zip/node_modules/react/index.js"),r=s("./packages/grafana-ui/src/index.ts"),o=s("./packages/grafana-runtime/src/index.ts"),l=s("./public/app/features/query/components/QueryEditorRows.tsx"),d=s("./public/app/core/services/backend_srv.ts"),c=s("./public/app/core/config.ts"),u=s("./packages/grafana-data/src/index.ts"),h=s("../../opt/drone/yarncache/react-npm-17.0.1-98658812fc-83b9df9529.zip/node_modules/react/jsx-runtime.js");function p(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class m extends a.PureComponent{constructor(...e){super(...e),p(this,"state",{isError:!1,isLoading:!1,help:""}),p(this,"loadHelp",(()=>{const{plugin:e,type:t}=this.props;this.setState({isLoading:!0}),(0,o.getBackendSrv)().get(`/api/plugins/${e.id}/markdown/${t}`).then((e=>{const s=(0,u.renderMarkdown)(e);""===e&&"help"===t?this.setState({isError:!1,isLoading:!1,help:this.constructPlaceholderInfo()}):this.setState({isError:!1,isLoading:!1,help:s})})).catch((()=>{this.setState({isError:!0,isLoading:!1})}))}))}componentDidMount(){this.loadHelp()}constructPlaceholderInfo(){return"No plugin help or readme markdown file was found"}render(){const{type:e}=this.props,{isError:t,isLoading:s,help:a}=this.state;return s?i||(i=(0,h.jsx)("h2",{children:"Loading help..."})):t?n||(n=(0,h.jsx)("h3",{children:"'Error occurred when loading help'"})):(0,h.jsx)("div",{className:"markdown-html",dangerouslySetInnerHTML:{__html:a}})}}var g,x,v,f,S,y,j,b,C,O=s("./public/app/core/utils/query.ts"),w=s("./public/app/features/expressions/ExpressionDatasource.ts"),T=s("./packages/grafana-e2e-selectors/src/index.ts"),R=s("./public/app/core/components/QueryOperationRow/QueryOperationRow.tsx"),I=s("./.yarn/__virtual__/@emotion-css-virtual-9fd25d72e0/3/opt/drone/yarncache/@emotion-css-npm-11.1.3-72aa05c30f-dc50283f65.zip/node_modules/@emotion/css/dist/emotion-css.esm.js");function Q(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class q extends a.PureComponent{constructor(e){var t,s,i,n;super(e),Q(this,"onRelativeTimeChange",(e=>{this.setState({timeRangeFrom:e.target.value})})),Q(this,"onTimeShiftChange",(e=>{this.setState({timeRangeShift:e.target.value})})),Q(this,"onOverrideTime",(e=>{var t;const{options:s,onChange:i}=this.props,n=k(e.target.value),a=D(n);var r;a&&(null===(t=s.timeRange)||void 0===t?void 0:t.from)!==n&&i(Object.assign({},s,{timeRange:Object.assign({},null!==(r=s.timeRange)&&void 0!==r?r:{},{from:n})}));this.setState({relativeTimeIsValid:a})})),Q(this,"onTimeShift",(e=>{var t;const{options:s,onChange:i}=this.props,n=k(e.target.value),a=D(n);var r;a&&(null===(t=s.timeRange)||void 0===t?void 0:t.shift)!==n&&i(Object.assign({},s,{timeRange:Object.assign({},null!==(r=s.timeRange)&&void 0!==r?r:{},{shift:n})}));this.setState({timeShiftIsValid:a})})),Q(this,"onToggleTimeOverride",(()=>{const{onChange:e,options:t}=this.props;this.setState({timeRangeHide:!this.state.timeRangeHide},(()=>{var s;e(Object.assign({},t,{timeRange:Object.assign({},null!==(s=t.timeRange)&&void 0!==s?s:{},{hide:this.state.timeRangeHide})}))}))})),Q(this,"onCacheTimeoutBlur",(e=>{const{options:t,onChange:s}=this.props;s(Object.assign({},t,{cacheTimeout:k(e.target.value)}))})),Q(this,"onMaxDataPointsBlur",(e=>{const{options:t,onChange:s}=this.props;let i=parseInt(e.target.value,10);(isNaN(i)||0===i)&&(i=null),i!==t.maxDataPoints&&s(Object.assign({},t,{maxDataPoints:i}))})),Q(this,"onMinIntervalBlur",(e=>{const{options:t,onChange:s}=this.props,i=k(e.target.value);i!==t.minInterval&&s(Object.assign({},t,{minInterval:i}))})),Q(this,"onOpenOptions",(()=>{this.setState({isOpen:!0})})),Q(this,"onCloseOptions",(()=>{this.setState({isOpen:!1})}));const{options:a}=e;this.state={timeRangeFrom:(null===(t=a.timeRange)||void 0===t?void 0:t.from)||"",timeRangeShift:(null===(s=a.timeRange)||void 0===s?void 0:s.shift)||"",timeRangeHide:null!==(i=null===(n=a.timeRange)||void 0===n?void 0:n.hide)&&void 0!==i&&i,isOpen:!1,relativeTimeIsValid:!0,timeShiftIsValid:!0}}renderCacheTimeoutOption(){var e,t;const{dataSource:s,options:i}=this.props;return null!==(e=s.meta.queryOptions)&&void 0!==e&&e.cacheTimeout?(0,h.jsx)("div",{className:"gf-form-inline",children:(0,h.jsxs)("div",{className:"gf-form",children:[(0,h.jsx)(r.InlineFormLabel,{width:9,tooltip:"If your time series store has a query cache this option can override the default cache timeout. Specify a\n    numeric value in seconds.",children:"Cache timeout"}),(0,h.jsx)(r.Input,{type:"text",className:"width-6",placeholder:"60",spellCheck:!1,onBlur:this.onCacheTimeoutBlur,defaultValue:null!==(t=i.cacheTimeout)&&void 0!==t?t:""})]})}):null}renderMaxDataPointsOption(){var e,t;const{data:s,options:i}=this.props,n=null===(e=s.request)||void 0===e?void 0:e.maxDataPoints,a=null!==(t=i.maxDataPoints)&&void 0!==t?t:"",o=""===a;return(0,h.jsx)("div",{className:"gf-form-inline",children:(0,h.jsxs)("div",{className:"gf-form",children:[g||(g=(0,h.jsx)(r.InlineFormLabel,{width:9,tooltip:(0,h.jsx)(h.Fragment,{children:"The maximum data points per series. Used directly by some data sources and used in calculation of auto interval. With streaming data this value is used for the rolling buffer."}),children:"Max data points"})),(0,h.jsx)(r.Input,{type:"number",className:"width-6",placeholder:`${n}`,spellCheck:!1,onBlur:this.onMaxDataPointsBlur,defaultValue:a}),o&&(0,h.jsxs)(h.Fragment,{children:[x||(x=(0,h.jsx)("div",{className:"gf-form-label query-segment-operator",children:"="})),v||(v=(0,h.jsx)("div",{className:"gf-form-label",children:"Width of panel"}))]})]})})}renderIntervalOption(){var e,t,s;const{data:i,dataSource:n,options:a}=this.props,o=null===(e=i.request)||void 0===e?void 0:e.interval,l=null!==(t=n.interval)&&void 0!==t?t:"No limit";return(0,h.jsxs)(h.Fragment,{children:[(0,h.jsx)("div",{className:"gf-form-inline",children:(0,h.jsxs)("div",{className:"gf-form",children:[f||(f=(0,h.jsx)(r.InlineFormLabel,{width:9,tooltip:(0,h.jsxs)(h.Fragment,{children:["A lower limit for the interval. Recommended to be set to write frequency, for example ",(0,h.jsx)("code",{children:"1m"})," ","if your data is written every minute. Default value can be set in data source settings for most data sources."]}),children:"Min interval"})),(0,h.jsx)(r.Input,{type:"text",className:"width-6",placeholder:`${l}`,spellCheck:!1,onBlur:this.onMinIntervalBlur,defaultValue:null!==(s=a.minInterval)&&void 0!==s?s:""})]})}),(0,h.jsx)("div",{className:"gf-form-inline",children:(0,h.jsxs)("div",{className:"gf-form",children:[S||(S=(0,h.jsx)(r.InlineFormLabel,{width:9,tooltip:(0,h.jsxs)(h.Fragment,{children:["The evaluated interval that is sent to data source and is used in ",(0,h.jsx)("code",{children:"$__interval"})," and"," ",(0,h.jsx)("code",{children:"$__interval_ms"})]}),children:"Interval"})),(0,h.jsx)(r.InlineFormLabel,{width:6,children:o}),y||(y=(0,h.jsx)("div",{className:"gf-form-label query-segment-operator",children:"="})),j||(j=(0,h.jsx)("div",{className:"gf-form-label",children:"Time range / max data points"}))]})})]})}renderCollapsedText(e){var t;const{data:s,options:i}=this.props,{isOpen:n}=this.state;if(n)return;let a=null!==(t=i.maxDataPoints)&&void 0!==t?t:"";""===a&&s.request&&(a=`auto = ${s.request.maxDataPoints}`);let r=i.minInterval;return s.request&&(r=`${s.request.interval}`),(0,h.jsxs)(h.Fragment,{children:[(0,h.jsxs)("div",{className:e.collapsedText,children:["MD = ",a]}),(0,h.jsxs)("div",{className:e.collapsedText,children:["Interval = ",r]})]})}render(){const{timeRangeHide:e,relativeTimeIsValid:t,timeShiftIsValid:s}=this.state,{timeRangeFrom:i,timeRangeShift:n,isOpen:a}=this.state,o=N();return(0,h.jsxs)(R.t,{id:"Query options",index:0,title:"Query options",headerElement:this.renderCollapsedText(o),isOpen:a,onOpen:this.onOpenOptions,onClose:this.onCloseOptions,children:[this.renderMaxDataPointsOption(),this.renderIntervalOption(),this.renderCacheTimeoutOption(),(0,h.jsxs)("div",{className:"gf-form",children:[b||(b=(0,h.jsx)(r.InlineFormLabel,{width:9,children:"Relative time"})),(0,h.jsx)(r.Input,{type:"text",className:"width-6",placeholder:"1h",onChange:this.onRelativeTimeChange,onBlur:this.onOverrideTime,invalid:!t,value:i})]}),(0,h.jsxs)("div",{className:"gf-form",children:[C||(C=(0,h.jsx)("span",{className:"gf-form-label width-9",children:"Time shift"})),(0,h.jsx)(r.Input,{type:"text",className:"width-6",placeholder:"1h",onChange:this.onTimeShiftChange,onBlur:this.onTimeShift,invalid:!s,value:n})]}),(n||i)&&(0,h.jsx)("div",{className:"gf-form-inline",children:(0,h.jsx)(r.InlineField,{label:"Hide time info",labelWidth:18,children:(0,h.jsx)(r.Switch,{value:e,onChange:this.onToggleTimeOverride})})})]})}}const D=e=>!e||u.rangeUtil.isValidTimeSpan(e),k=e=>""===e?null:e,N=(0,r.stylesFactory)((()=>{const{theme:e}=c.vc;return{collapsedText:I.css`
      margin-left: ${e.spacing.md};
      font-size: ${e.typography.size.sm};
      color: ${e.colors.textWeak};
    `}}));var B,P,A,F=s("./public/app/plugins/datasource/dashboard/index.ts"),M=s("./public/app/features/query/components/QueryActionComponent.ts"),H=s("./packages/grafana-runtime/src/utils/DataSourceWithBackend.ts");function E(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class L extends a.PureComponent{constructor(...e){super(...e),E(this,"backendSrv",d.ae),E(this,"dataSourceSrv",(0,o.getDataSourceSrv)()),E(this,"querySubscription",null),E(this,"state",{isLoadingHelp:!1,helpContent:null,isPickerOpen:!1,isAddingMixed:!1,isHelpOpen:!1,scrollTop:0,queries:[],data:{state:u.LoadingState.NotStarted,series:[],timeRange:(0,u.getDefaultTimeRange)()}}),E(this,"onChangeDataSource",(async e=>{const{dsSettings:t}=this.state,s=function(e,t,s){const i=(0,u.getDataSourceRef)(e);return(null==s?void 0:s.type)!==e.type?e.meta.mixed?t:[{refId:"A",datasource:i}]:t.map((e=>((0,H.Pr)(e.datasource)||(e.datasource=i),e)))}(e,this.state.queries,t),i=await this.dataSourceSrv.get(e.name);this.onChange({queries:s,dataSource:{name:e.name,uid:e.uid,type:e.meta.id,default:e.isDefault}}),this.setState({queries:s,dataSource:i,dsSettings:e})})),E(this,"onAddQueryClick",(()=>{const{queries:e}=this.state;this.onQueriesChange((0,O.DI)(e,this.newQuery())),this.onScrollBottom()})),E(this,"onAddExpressionClick",(()=>{this.onQueriesChange((0,O.DI)(this.state.queries,w.mV.newQuery())),this.onScrollBottom()})),E(this,"onScrollBottom",(()=>{this.setState({scrollTop:1e3})})),E(this,"onUpdateAndRun",(e=>{this.props.onOptionsChange(e),this.props.onRunQueries()})),E(this,"onOpenHelp",(()=>{this.setState({isHelpOpen:!0})})),E(this,"onCloseHelp",(()=>{this.setState({isHelpOpen:!1})})),E(this,"renderMixedPicker",(()=>(0,h.jsx)(o.DataSourcePicker,{mixed:!1,onChange:this.onAddMixedQuery,current:null,autoFocus:!0,variables:!0,onBlur:this.onMixedPickerBlur,openMenuOnFocus:!0}))),E(this,"onAddMixedQuery",(e=>{this.onAddQuery({datasource:e.name}),this.setState({isAddingMixed:!1,scrollTop:this.state.scrollTop+1e4})})),E(this,"onMixedPickerBlur",(()=>{this.setState({isAddingMixed:!1})})),E(this,"onAddQuery",(e=>{const{dsSettings:t,queries:s}=this.state;this.onQueriesChange((0,O.DI)(s,e,{type:null==t?void 0:t.type,uid:null==t?void 0:t.uid})),this.onScrollBottom()})),E(this,"setScrollTop",(({scrollTop:e})=>{this.setState({scrollTop:e})})),E(this,"onQueriesChange",(e=>{this.onChange({queries:e}),this.setState({queries:e})}))}async componentDidMount(){const{queryRunner:e,options:t}=this.props;this.querySubscription=e.getData({withTransforms:!1,withFieldConfig:!1}).subscribe({next:e=>this.onPanelDataUpdate(e)});try{const e=await this.dataSourceSrv.get(t.dataSource),s=this.dataSourceSrv.getInstanceSettings(t.dataSource),i=await this.dataSourceSrv.get(),n=e.getRef(),a=t.queries.map((e=>e.datasource?e:Object.assign({},e,{datasource:n})));this.setState({queries:a,dataSource:e,dsSettings:s,defaultDataSource:i})}catch(e){console.log("failed to load data source",e)}}componentWillUnmount(){this.querySubscription&&(this.querySubscription.unsubscribe(),this.querySubscription=null)}onPanelDataUpdate(e){this.setState({data:e})}newQuery(){const{dsSettings:e,defaultDataSource:t}=this.state,s=null!=e&&e.meta.mixed?t:e;return{datasource:{uid:null==s?void 0:s.uid,type:null==s?void 0:s.type}}}onChange(e){this.props.onOptionsChange(Object.assign({},this.props.options,e))}renderTopSection(e){const{onOpenQueryInspector:t,options:s}=this.props,{dataSource:i,data:n}=this.state;return(0,h.jsx)("div",{children:(0,h.jsxs)("div",{className:e.dataSourceRow,children:[B||(B=(0,h.jsx)(r.InlineFormLabel,{htmlFor:"data-source-picker",width:"auto",children:"Data source"})),(0,h.jsx)("div",{className:e.dataSourceRowItem,children:(0,h.jsx)(o.DataSourcePicker,{onChange:this.onChangeDataSource,current:s.dataSource,metrics:!0,mixed:!0,dashboard:!0,variables:!0})}),i&&(0,h.jsxs)(h.Fragment,{children:[(0,h.jsx)("div",{className:e.dataSourceRowItem,children:(0,h.jsx)(r.Button,{variant:"secondary",icon:"question-circle",title:"Open data source help",onClick:this.onOpenHelp})}),(0,h.jsx)("div",{className:e.dataSourceRowItemOptions,children:(0,h.jsx)(q,{options:s,dataSource:i,data:n,onChange:this.onUpdateAndRun})}),t&&(0,h.jsx)("div",{className:e.dataSourceRowItem,children:(0,h.jsx)(r.Button,{variant:"secondary",onClick:t,"aria-label":T.wl.components.QueryTab.queryInspectorButton,children:"Query inspector"})})]})]})})}renderQueries(e){const{onRunQueries:t}=this.props,{data:s,queries:i}=this.state;return(0,F.yl)(e.name)?(0,h.jsx)(F.hD,{queries:i,panelData:s,onChange:this.onQueriesChange,onRunQueries:t}):(0,h.jsx)("div",{"aria-label":T.wl.components.QueryTab.content,children:(0,h.jsx)(l.l,{queries:i,dsSettings:e,onQueriesChange:this.onQueriesChange,onAddQuery:this.onAddQuery,onRunQueries:t,data:s})})}isExpressionsSupported(e){return!0===(e.meta.alerting||e.meta.mixed)}renderExtraActions(){return M.S.getAllExtraRenderAction().map(((e,t)=>e({onAddQuery:this.onAddQuery,onChangeDataSource:this.onChangeDataSource,key:t}))).filter(Boolean)}renderAddQueryRow(e,t){const{isAddingMixed:s}=this.state,i=!(s||(0,F.yl)(e.name));return(0,h.jsxs)(r.HorizontalGroup,{spacing:"md",align:"flex-start",children:[i&&(0,h.jsx)(r.Button,{icon:"plus",onClick:this.onAddQueryClick,variant:"secondary","aria-label":T.wl.components.QueryTab.addQuery,children:"Query"}),c.ZP.expressionsEnabled&&this.isExpressionsSupported(e)&&(0,h.jsx)(r.Tooltip,{content:"Beta feature: queries could stop working in next version",placement:"right",children:(0,h.jsxs)(r.Button,{icon:"plus",onClick:this.onAddExpressionClick,variant:"secondary",className:t.expressionButton,children:[P||(P=(0,h.jsx)("span",{children:"ExpressionÂ "})),A||(A=(0,h.jsx)(r.Icon,{name:"exclamation-triangle",className:"muted",size:"sm"}))]})}),this.renderExtraActions()]})}render(){const{scrollTop:e,isHelpOpen:t,dsSettings:s}=this.state,i=$();return(0,h.jsx)(r.CustomScrollbar,{autoHeightMin:"100%",scrollTop:e,setScrollTop:this.setScrollTop,children:(0,h.jsxs)("div",{className:i.innerWrapper,children:[this.renderTopSection(i),s&&(0,h.jsxs)(h.Fragment,{children:[(0,h.jsx)("div",{className:i.queriesWrapper,children:this.renderQueries(s)}),this.renderAddQueryRow(s,i),t&&(0,h.jsx)(r.Modal,{title:"Data source help",isOpen:!0,onDismiss:this.onCloseHelp,children:(0,h.jsx)(m,{plugin:s.meta,type:"query_help"})})]})]})})}}const $=(0,r.stylesFactory)((()=>{const{theme:e}=c.ZP;return{innerWrapper:I.css`
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: ${e.spacing.md};
    `,dataSourceRow:I.css`
      display: flex;
      margin-bottom: ${e.spacing.md};
    `,dataSourceRowItem:I.css`
      margin-right: ${e.spacing.inlineFormMargin};
    `,dataSourceRowItemOptions:I.css`
      flex-grow: 1;
      margin-right: ${e.spacing.inlineFormMargin};
    `,queriesWrapper:I.css`
      padding-bottom: 16px;
    `,expressionWrapper:I.css``,expressionButton:I.css`
      margin-right: ${e.spacing.sm};
    `}}))}}]);
//# sourceMappingURL=3453.1f65f885c5a67f13d9d6.js.map