"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[450],{"./public/app/plugins/datasource/graphite/graphite_query.ts":(e,t,s)=>{s.d(t,{Z:()=>m});var i=s("../../opt/drone/yarncache/lodash-npm-4.17.21-6382451519-eb835a2e51.zip/node_modules/lodash/lodash.js"),r=s("./public/app/core/utils/arrayMove.ts");function n(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}const a=[170,170,181,181,186,186,192,214,216,246,248,705,710,721,736,740,748,748,750,750,880,884,886,887,890,893,902,902,904,906,908,908,910,929,931,1013,1015,1153,1162,1319,1329,1366,1369,1369,1377,1415,1488,1514,1520,1522,1568,1610,1646,1647,1649,1747,1749,1749,1765,1766,1774,1775,1786,1788,1791,1791,1808,1808,1810,1839,1869,1957,1969,1969,1994,2026,2036,2037,2042,2042,2048,2069,2074,2074,2084,2084,2088,2088,2112,2136,2308,2361,2365,2365,2384,2384,2392,2401,2417,2423,2425,2431,2437,2444,2447,2448,2451,2472,2474,2480,2482,2482,2486,2489,2493,2493,2510,2510,2524,2525,2527,2529,2544,2545,2565,2570,2575,2576,2579,2600,2602,2608,2610,2611,2613,2614,2616,2617,2649,2652,2654,2654,2674,2676,2693,2701,2703,2705,2707,2728,2730,2736,2738,2739,2741,2745,2749,2749,2768,2768,2784,2785,2821,2828,2831,2832,2835,2856,2858,2864,2866,2867,2869,2873,2877,2877,2908,2909,2911,2913,2929,2929,2947,2947,2949,2954,2958,2960,2962,2965,2969,2970,2972,2972,2974,2975,2979,2980,2984,2986,2990,3001,3024,3024,3077,3084,3086,3088,3090,3112,3114,3123,3125,3129,3133,3133,3160,3161,3168,3169,3205,3212,3214,3216,3218,3240,3242,3251,3253,3257,3261,3261,3294,3294,3296,3297,3313,3314,3333,3340,3342,3344,3346,3386,3389,3389,3406,3406,3424,3425,3450,3455,3461,3478,3482,3505,3507,3515,3517,3517,3520,3526,3585,3632,3634,3635,3648,3654,3713,3714,3716,3716,3719,3720,3722,3722,3725,3725,3732,3735,3737,3743,3745,3747,3749,3749,3751,3751,3754,3755,3757,3760,3762,3763,3773,3773,3776,3780,3782,3782,3804,3805,3840,3840,3904,3911,3913,3948,3976,3980,4096,4138,4159,4159,4176,4181,4186,4189,4193,4193,4197,4198,4206,4208,4213,4225,4238,4238,4256,4293,4304,4346,4348,4348,4352,4680,4682,4685,4688,4694,4696,4696,4698,4701,4704,4744,4746,4749,4752,4784,4786,4789,4792,4798,4800,4800,4802,4805,4808,4822,4824,4880,4882,4885,4888,4954,4992,5007,5024,5108,5121,5740,5743,5759,5761,5786,5792,5866,5870,5872,5888,5900,5902,5905,5920,5937,5952,5969,5984,5996,5998,6e3,6016,6067,6103,6103,6108,6108,6176,6263,6272,6312,6314,6314,6320,6389,6400,6428,6480,6509,6512,6516,6528,6571,6593,6599,6656,6678,6688,6740,6823,6823,6917,6963,6981,6987,7043,7072,7086,7087,7104,7141,7168,7203,7245,7247,7258,7293,7401,7404,7406,7409,7424,7615,7680,7957,7960,7965,7968,8005,8008,8013,8016,8023,8025,8025,8027,8027,8029,8029,8031,8061,8064,8116,8118,8124,8126,8126,8130,8132,8134,8140,8144,8147,8150,8155,8160,8172,8178,8180,8182,8188,8305,8305,8319,8319,8336,8348,8450,8450,8455,8455,8458,8467,8469,8469,8473,8477,8484,8484,8486,8486,8488,8488,8490,8493,8495,8505,8508,8511,8517,8521,8526,8526,8544,8584,11264,11310,11312,11358,11360,11492,11499,11502,11520,11557,11568,11621,11631,11631,11648,11670,11680,11686,11688,11694,11696,11702,11704,11710,11712,11718,11720,11726,11728,11734,11736,11742,11823,11823,12293,12295,12321,12329,12337,12341,12344,12348,12353,12438,12445,12447,12449,12538,12540,12543,12549,12589,12593,12686,12704,12730,12784,12799,13312,13312,19893,19893,19968,19968,40907,40907,40960,42124,42192,42237,42240,42508,42512,42527,42538,42539,42560,42606,42623,42647,42656,42735,42775,42783,42786,42888,42891,42894,42896,42897,42912,42921,43002,43009,43011,43013,43015,43018,43020,43042,43072,43123,43138,43187,43250,43255,43259,43259,43274,43301,43312,43334,43360,43388,43396,43442,43471,43471,43520,43560,43584,43586,43588,43595,43616,43638,43642,43642,43648,43695,43697,43697,43701,43702,43705,43709,43712,43712,43714,43714,43739,43741,43777,43782,43785,43790,43793,43798,43808,43814,43816,43822,43968,44002,44032,44032,55203,55203,55216,55238,55243,55291,63744,64045,64048,64109,64112,64217,64256,64262,64275,64279,64285,64285,64287,64296,64298,64310,64312,64316,64318,64318,64320,64321,64323,64324,64326,64433,64467,64829,64848,64911,64914,64967,65008,65019,65136,65140,65142,65276,65313,65338,65345,65370,65382,65470,65474,65479,65482,65487,65490,65495,65498,65500,65536,65547,65549,65574,65576,65594,65596,65597,65599,65613,65616,65629,65664,65786,65856,65908,66176,66204,66208,66256,66304,66334,66352,66378,66432,66461,66464,66499,66504,66511,66513,66517,66560,66717,67584,67589,67592,67592,67594,67637,67639,67640,67644,67644,67647,67669,67840,67861,67872,67897,68096,68096,68112,68115,68117,68119,68121,68147,68192,68220,68352,68405,68416,68437,68448,68466,68608,68680,69635,69687,69763,69807,73728,74606,74752,74850,77824,78894,92160,92728,110592,110593,119808,119892,119894,119964,119966,119967,119970,119970,119973,119974,119977,119980,119982,119993,119995,119995,119997,120003,120005,120069,120071,120074,120077,120084,120086,120092,120094,120121,120123,120126,120128,120132,120134,120134,120138,120144,120146,120485,120488,120512,120514,120538,120540,120570,120572,120596,120598,120628,120630,120654,120656,120686,120688,120712,120714,120744,120746,120770,120772,120779,131072,131072,173782,173782,173824,173824,177972,177972,177984,177984,178205,178205,194560,195101],h=[];for(let e=0;e<128;e++)h[e]=e>=48&&e<=57||36===e||126===e||124===e||e>=65&&e<=90||95===e||45===e||42===e||58===e||91===e||93===e||63===e||37===e||35===e||61===e||e>=97&&e<=122;const u=h;class o{constructor(e){n(this,"input",void 0),n(this,"char",void 0),n(this,"from",void 0),this.input=e,this.char=1,this.from=1}peek(e){return this.input.charAt(e||0)}skip(e){e=e||1,this.char+=e,this.input=this.input.slice(e)}tokenize(){const e=[];let t=this.next();for(;t;)e.push(t),t=this.next();return e}next(){if(this.from=this.char,/\s/.test(this.peek())){for(;/\s/.test(this.peek());)this.from+=1,this.skip();if(""===this.peek())return null}let e=this.scanStringLiteral();return e||(e=this.scanPunctuator()||this.scanNumericLiteral()||this.scanIdentifier()||this.scanTemplateSequence(),e?(this.skip(e.value.length),e):null)}scanTemplateSequence(){return"["===this.peek()&&"["===this.peek(1)?{type:"templateStart",value:"[[",pos:this.char}:"]"===this.peek()&&"]"===this.peek(1)?{type:"templateEnd",value:"[[",pos:this.char}:null}scanIdentifier(){let e,t,s="",r=0;function n(e){for(let t=0;t<a.length;){if(e<a[t++])return!1;if(e<=a[t++])return!0}return!1}function o(e){return/^[0-9a-fA-F]$/.test(e)}const c=(0,i.bind)((function(){if(r+=1,"u"!==this.peek(r))return null;const e=this.peek(r+1),t=this.peek(r+2),s=this.peek(r+3),i=this.peek(r+4);let a;return o(e)&&o(t)&&o(s)&&o(i)?(a=parseInt(e+t+s+i,16),n(a)?(r+=5,"\\u"+e+t+s+i):null):null}),this),l=(0,i.bind)((function(){const e=this.peek(r),t=e.charCodeAt(0);return"*"===e?(r+=1,e):92===t?c():t<128?h[t]?(r+=1,e):null:n(t)?(r+=1,e):null}),this),p=(0,i.bind)((function(){const e=this.peek(r),t=e.charCodeAt(0);return 92===t?c():t<128?u[t]?(r+=1,e):null:n(t)?(r+=1,e):null}),this);if(t=l(),null===t)return null;for(s=t;t=p(),null!==t;)s+=t;switch(s){case"true":case"false":e="bool";break;default:e="identifier"}return{type:e,value:s,pos:this.char}}scanNumericLiteral(){let e=0,t="";const s=this.input.length;let i,r=this.peek(e);function n(e){return/^[0-9]$/.test(e)}function a(e){return/^[0-7]$/.test(e)}function h(e){return"$"===e||"_"===e||"\\"===e||e>="a"&&e<="z"||e>="A"&&e<="Z"}if("-"===r&&(t+=r,e+=1,r=this.peek(e)),"."!==r&&!n(r))return null;if("."!==r){if(t+=this.peek(e),e+=1,r=this.peek(e),"0"===t){if("x"===r||"X"===r){for(e+=1,t+=r;e<s&&(r=this.peek(e),/^[0-9a-fA-F]$/.test(r));)t+=r,e+=1;return t.length<=2?{type:"number",value:t,isMalformed:!0,pos:this.char}:e<s&&(r=this.peek(e),h(r))?null:{type:"number",value:t,base:16,isMalformed:!1,pos:this.char}}if(a(r)){for(e+=1,t+=r,i=!1;e<s;){if(r=this.peek(e),n(r)&&(i=!0),!a(r)){if(!this.isPunctuator(r))return null;break}t+=r,e+=1}return e<s&&(r=this.peek(e),h(r))?null:{type:"number",value:t,base:8,isMalformed:i}}n(r)&&(e+=1,t+=r)}for(;e<s&&(r=this.peek(e),n(r));)t+=r,e+=1}if("."===r)for(t+=r,e+=1;e<s&&(r=this.peek(e),n(r));)t+=r,e+=1;if("e"===r||"E"===r){if(t+=r,e+=1,r=this.peek(e),"+"!==r&&"-"!==r||(t+=this.peek(e),e+=1),r=this.peek(e),!n(r))return null;for(t+=r,e+=1;e<s&&(r=this.peek(e),n(r));)t+=r,e+=1}return e<s&&(r=this.peek(e),!this.isPunctuator(r))?null:{type:"number",value:t,base:10,pos:this.char,isMalformed:!isFinite(+t)}}isPunctuator(e){switch(e){case".":case"(":case")":case",":case"{":case"}":return!0}return!1}scanPunctuator(){const e=this.peek();return this.isPunctuator(e)?{type:e,value:e,pos:this.char}:null}scanStringLiteral(){const e=this.peek();if('"'!==e&&"'"!==e)return null;let t="";for(this.skip();this.peek()!==e;){if(""===this.peek())return{type:"string",value:t,isUnclosed:!0,quote:e,pos:this.char};const s=1;t+=this.peek(),this.skip(s)}return this.skip(),{type:"string",value:t,isUnclosed:!1,quote:e,pos:this.char}}}function c(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class l{constructor(e){c(this,"expression",void 0),c(this,"lexer",void 0),c(this,"tokens",void 0),c(this,"index",void 0),this.expression=e,this.lexer=new o(e),this.tokens=this.lexer.tokenize(),this.index=0}getAst(){return this.start()}start(){try{return this.functionCall()||this.metricExpression()}catch(e){return{type:"error",message:e.message,pos:e.pos}}}curlyBraceSegment(){if(this.match("identifier","{")||this.match("{")){let e="";for(;!this.match("")&&!this.match("}");)e+=this.consumeToken().value;return this.match("}")||this.errorMark("Expected closing '}'"),e+=this.consumeToken().value,this.match("identifier")&&(e+=this.consumeToken().value),{type:"segment",value:e}}return null}metricSegment(){const e=this.curlyBraceSegment();if(e)return e;if(this.match("identifier")||this.match("number")){const e=this.consumeToken().value.split(".");return 2===e.length&&(this.tokens.splice(this.index,0,{type:"."}),this.tokens.splice(this.index+1,0,{type:"number",value:e[1]})),{type:"segment",value:e[0]}}this.match("templateStart")||this.errorMark("Expected metric identifier"),this.consumeToken(),this.match("identifier")||this.errorMark("Expected identifier after templateStart");const t={type:"template",value:this.consumeToken().value};return this.match("templateEnd")||this.errorMark("Expected templateEnd"),this.consumeToken(),t}metricExpression(){if(!(this.match("templateStart")||this.match("identifier")||this.match("number")||this.match("{")))return null;const e={type:"metric",segments:[]};for(e.segments.push(this.metricSegment());this.match(".");){this.consumeToken();const t=this.metricSegment();t||this.errorMark("Expected metric identifier"),e.segments.push(t)}return e}functionCall(){if(!this.match("identifier","("))return null;const e={type:"function",name:this.consumeToken().value};return this.consumeToken(),e.params=this.functionParameters(),this.match(")")||this.errorMark("Expected closing parenthesis"),this.consumeToken(),e}boolExpression(){return this.match("bool")?{type:"bool",value:"true"===this.consumeToken().value}:null}functionParameters(){if(this.match(")")||this.match(""))return[];const e=this.functionCall()||this.numericLiteral()||this.seriesRefExpression()||this.boolExpression()||this.metricExpression()||this.stringLiteral();return this.match(",")?(this.consumeToken(),[e].concat(this.functionParameters())):[e]}seriesRefExpression(){if(!this.match("identifier"))return null;if(!this.tokens[this.index].value.match(/\#[A-Z]/))return null;return{type:"series-ref",value:this.consumeToken().value}}numericLiteral(){return this.match("number")?{type:"number",value:parseFloat(this.consumeToken().value)}:null}stringLiteral(){if(!this.match("string"))return null;const e=this.consumeToken();if(e.isUnclosed)throw{message:"Unclosed string parameter",pos:e.pos};return{type:"string",value:e.value}}errorMark(e){const t=this.tokens[this.index];throw{message:e+" instead found "+(t?t.type:"end of string"),pos:t?t.pos:this.lexer.char}}consumeToken(){return this.index++,this.tokens[this.index-1]}matchToken(e,t){const s=this.tokens[this.index+t];return void 0===s&&""===e||s&&s.type===e}match(e,t){return this.matchToken(e,0)&&(!t||this.matchToken(t,1))}}function p(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class m{constructor(e,t,s,i){p(this,"datasource",void 0),p(this,"target",void 0),p(this,"functions",[]),p(this,"segments",[]),p(this,"tags",[]),p(this,"error",void 0),p(this,"seriesByTagUsed",!1),p(this,"checkOtherSegmentsIndex",0),p(this,"removeTagValue",void 0),p(this,"templateSrv",void 0),p(this,"scopedVars",void 0),this.datasource=e,this.target=t,this.templateSrv=s,this.scopedVars=i,this.parseTarget(),this.removeTagValue="-- remove tag --"}parseTarget(){if(this.functions=[],this.segments=[],this.tags=[],this.seriesByTagUsed=!1,this.error=null,this.target.textEditor)return;const e=new l(this.target.target).getAst();if(null!==e){if("error"===e.type)return this.error=e.message+" at position: "+e.pos,void(this.target.textEditor=!0);try{this.parseTargetRecursive(e,null)}catch(e){console.error("error parsing target:",e.message),this.error=e.message,this.target.textEditor=!0}this.checkOtherSegmentsIndex=this.segments.length-1}else this.checkOtherSegmentsIndex=0}getSegmentPathUpTo(e){const t=this.segments.slice(0,e);return(0,i.reduce)(t,((e,t)=>e?e+"."+t.value:t.value),"")}parseTargetRecursive(e,t){if(null===e)return null;switch(e.type){case"function":const s=this.datasource.createFuncInstance(e.name,{withDefaultParams:!1});(0,i.each)(e.params,(e=>{this.parseTargetRecursive(e,s)})),s.updateText(),this.functions.push(s),"seriesByTag"!==s.def.name||this.seriesByTagUsed||(this.seriesByTagUsed=!0,s.hidden=!0,this.tags=this.splitSeriesByTagParams(s));break;case"series-ref":this.segments.length>0||this.getSeriesByTagFuncIndex()>=0?this.addFunctionParameter(t,e.value):this.segments.push(e);break;case"bool":case"string":case"number":this.addFunctionParameter(t,e.value);break;case"metric":this.segments.length||this.tags.length?this.addFunctionParameter(t,(0,i.join)((0,i.map)(e.segments,"value"),".")):this.segments=e.segments}}updateSegmentValue(e,t){this.segments[t].value=e.value}addSelectMetricSegment(){this.segments.push({value:"select metric"})}addFunction(e){this.functions.push(e)}addFunctionParameter(e,t){if(e.params.length>=e.def.params.length&&!(0,i.get)((0,i.last)(e.def.params),"multiple",!1))throw{message:"too many parameters for function "+e.def.name};e.params.push(t)}removeFunction(e){this.functions=(0,i.without)(this.functions,e)}moveFunction(e,t){const s=this.functions.indexOf(e);(0,r.R)(this.functions,s,s+t)}updateModelTarget(e){const t=(e,t)=>t.render(e,(e=>this.templateSrv.replace(e,this.scopedVars)));if(!this.target.textEditor){const e=this.getSegmentPathUpTo(this.segments.length).replace(/\.?select metric$/,"");this.target.target=(0,i.reduce)(this.functions,t,e)}this.updateRenderedTarget(this.target,e);for(const t of e||[])t.refId!==this.target.refId&&this.updateRenderedTarget(t,e);this.functions.forEach((e=>e.added=!1))}updateRenderedTarget(e,t){const s=(0,i.keyBy)(t,"refId");delete s[e.refId];const r=/\#([A-Z])/g;let n=e.target;for((0,i.each)(s,((e,t)=>{!function(e,t){let s=0;(0,i.each)(e,((e,i)=>{if(i!==t){const t=r.exec(e.target),i=t&&t.length?t.length-1:0;s+=i}})),e[t].refCount=s}(s,t)}));n.match(r);){const e=n.replace(r,((e,t)=>{const i=s[t];return i?(0===i.refCount&&delete s[t],i.refCount--,i.target):e}));if(e===n)break;n=e}delete e.targetFull,e.target!==n&&(e.targetFull=n)}splitSeriesByTagParams(e){const t=/([^\!=~]+)(\!?=~?)(.*)/;return(0,i.flatten)((0,i.map)(e.params,(e=>{const s=t.exec(e);if(s){const e=s.slice(1);if(3===e.length)return{key:e[0],operator:e[1],value:e[2]}}return[]})))}getSeriesByTagFuncIndex(){return(0,i.findIndex)(this.functions,(e=>"seriesByTag"===e.def.name))}getSeriesByTagFunc(){const e=this.getSeriesByTagFuncIndex();return e>=0?this.functions[e]:void 0}addTag(e){const t=g(e);this.getSeriesByTagFunc().params.push(t),this.tags.push(e)}removeTag(e){this.getSeriesByTagFunc().params.splice(e,1),this.tags.splice(e,1)}updateTag(e,t){if(this.error=null,e.key===this.removeTagValue)return this.removeTag(t),void(0===this.tags.length&&(this.removeFunction(this.getSeriesByTagFunc()),this.checkOtherSegmentsIndex=0,this.seriesByTagUsed=!1));this.getSeriesByTagFunc().params[t]=g(e),this.tags[t]=e}renderTagExpressions(e=-1){return(0,i.compact)((0,i.map)(this.tags,((t,s)=>s!==e?t.key+t.operator+t.value:void 0)))}}function g(e){return e.key+e.operator+e.value}m.$inject=["datasource","target","templateSrv","scopedVars"]}}]);
//# sourceMappingURL=450.1f65f885c5a67f13d9d6.js.map